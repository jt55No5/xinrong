/**
 * @author    : aNd1coder
 * @overview  : 我的账户
 * @update    : $Id: user-min.js 2286 2013-06-01 03:33:05Z and1coder $
 * TODO      :  重构代码,进一步抽象视图渲染逻辑,实现基于HTML5通用验证框架
 */

var g_timer;//定时器

var is_reSendSms=false;

var checkIsLogin=100000;

var isCommitting=false;
(function (AA) {
    AA.User = {
        /**
         * 表单验证是否成功 (默认为false)
         */
        isValid:false ,

        bankcard_modify_dialog:null,
        /**
         * 表单验证成功提醒
         * @param _tip          提示元素(jquery对象)
         * @return {Boolean}    返回true
         */
        success:function (_tip ,msg) {
            var _msg = msg || '';
            if (_msg == '') {
                _tip.hide();
            } else {
                _tip.removeClass('info error warn').addClass('success').html(_msg);
            }
            AA.User.isValid = true;
            return true;
        } ,
        /**
         * 表单验证错误提醒
         * @param _tip        提示元素(jquery对象)
         * @param error       错误信息
         * @return {Boolean}  返回false
         */
        warning:function (_tip ,error) {
            _tip.removeClass('info warn success').addClass('error').show().html(error);
            AA.User.isValid = false;
            return false;
        } ,
        getContract:function(loanid)
        {
            $.ajax({
                url:'/v2/project/get_contract_by_loan_id.jso',
                type:'post',
                dataType:'json',
                data:{
                    loanId:loanid,
                },
                success:function(result){
                    if(result.state==0)
                    {
                            window.open(result.link,'_self');
                    }
                    else {

                        $.dialog({
                            'title':'合同' ,
                            'padding':'0' ,
                            'content': $('#wgt-dialog-loan-contract-error-wrapper').html(),
                            'initialize':function () {
                                 $('#contract-error-msg').val(result.msg);
                            }
                        });
                    }
                }
            });
        },
        /**
         * 渲染表格视图
         * @param data      参数
         * @param callback  回调函数
         */
        renderView:function (data ,callback) {
            var _d = data,
                _api = _d.api || AA.Api.User.loansInfo2,
                _caption = _d.caption || '投资记录',
                _displays = _d.displays || ['投资项目','投资时间','投资金额&nbsp;&nbsp;','期限','预期年化收益率','实收收益','投资奖励','回款日期','状态'],
                _fields = _d.fields || ['title','date','money g-money','deadline','rate','gains g-money','state'],
                _render = _d.render || AA.User.render;

            _api(_d.data ,function (result) {
                $(".wgt-datagrid").datagrid({
                    'caption':_caption ,
                    'displays':_displays ,
                    'fields':_fields ,
                    "data":result ,
                    "render":function (rows ,body) {

                        _render(rows ,body);

                        //查看详情
                        $('.wgt-datagrid-container a[rel="detail"]').click(function () {
                            AA.getInvestInfo && AA.getInvestInfo(this);
                        });



                        //收益详情
                        $('.wgt-datagrid-container a[rel="income-detail"]').click(function () {
                            var _lid = $(this).data("lid"),
                                _income_detail_dialog_html = $('#wgt-dialog-income-detail-wrapper').html();

                            AA.Api.Loan.getIncomeInfo2({loanId:_lid} ,function (result) {
                                $.dialog({
                                    'title':'收益详情' ,
                                    'lock':true ,
                                    'padding':'0' ,
                                    'content':_income_detail_dialog_html ,
                                    'initialize':function () {

                                        var _dialog = this;
                                        if (result.state == 0) {

                                            var _d = result.data;
                                            var show_name=AA.Lang.PRODUCT_NAME;
                                        	if(_d.loanType==2){
                                        		show_name='信<i class="g-dian">·</i>优企贷';
                                        	}else if(_d.loanType==3){
                                        		show_name='信<i class="g-dian">·</i>赎楼贷';
                                        	}else if(_d.loanType==4||_d.loanType==7||_d.loanType==11){

            									show_name='信<i class="g-dian">·</i>消费贷';
                                        	}else if(_d.loanType==5){
                                        		show_name='信<i class="g-dian">·</i>精选贷';
                                        	}else if(_d.loanType==6){
                                        		show_name='信<i class="g-dian">·</i>质抵贷';
                                        	}else if(_d.loanType==8){
                                        		show_name='品<i class="g-dian">·</i>融360';
                                        	}else if(_d.loanType==9){
                                        		show_name='品<i class="g-dian">·</i>吉屋网';
                                        	}else if(_d.loanType==10){
                                        		show_name='信<i class="g-dian">·</i>优资贷';
                                        	}else if(_d.loanType==12){
                                        		show_name='品<i class="g-dian">·</i>保理贷';
                                        	}else if(_d.loanType==13){
                                        		show_name='品<i class="g-dian">·</i>分期X';
                                        	}else if(_d.loanType==14){
                                        		show_name='信<i class="g-dian">·</i>消费JS';
                                        	}else if(_d.loanType==15){
                                        		show_name='品<i class="g-dian">·</i>票据贷';
                                        	}else if(_d.loanType==16){
                                        		show_name='信<i class="g-dian">·</i>车贷';
                                        	}else if(_d.loanType==17){
                                                show_name='品<i class="g-dian">·</i>明特';
                                            }

                                            $(".income-detail .sn").html(show_name + '-' + _d.sn);
                                            $(".income-detail .rStatus").html(AA.Api.Loan.status[_d.rStatus]);
                                            $(".income-detail .total").html(toDecimal(_d.total));
                                            $(".income-detail .interest").html(toDecimal(_d.interest));
                                            $(".income-detail .binterest").html(toDecimal(_d.binterest));
                                            $(".income-detail .breach").html(toDecimal(_d.breach));
                                            $(".income-detail .earnTotal").html(toDecimal(_d.earnTotal));
                                            $(".income-detail .pay").html(toDecimal(_d.pay));
                                            $(".income-detail .rate").html(toDecimal(_d.investRate));
                                            $(".income-detail .vipRate").html(toDecimal(_d.vipRate));
                                            $(".income-detail .earnInte").html(toDecimal(_d.earnInte));
                                            $(".income-detail .earnBinte").html(toDecimal(_d.earnBinte));
                                            $(".income-detail .vipNext").html(_d.vipNext);

                                            if (_d.days) {
                                                _days_label = _d.rStatus == 2 ?
                                                    ('逾期' + _d.days + '天') : (_d.rStatus == 5 ?
                                                    ('逾期回款' + _d.days + '个月') :
                                                    ('提前还款' + _d.days + '个月'));

                                                $('.days').html(' (' + _days_label + ')');
                                            } else {
                                                $('.days').html('');
                                            }

                                            $('.wgt-dialog-income-detail .ui-button').click(function () {
                                                _dialog.close();
                                            });
                                        } else {
                                            if (result.state == 1009) {
                                                _dialog.close();
                                                AA.RapidLogin.popup();
                                            }
                                        }
                                    }
                                });
                            });
                        });

                        //追加回调函数,比如分页
                        callback && callback(result);
                    } ,
                    'error':function () {
                        $('.wgt-pagination').html('');
                    }
                });
            });
        } ,
        /**
         * 渲染表格
         * @param rows
         * @param body
         */
        render:function (rows ,body) {
            var _body_html = '';
            $.each(rows ,function (index ,row) {


            	var show_name=AA.Lang.PRODUCT_NAME;
            	if(row.lt==2){
            		show_name='信<i class="g-dian">·</i>优企贷';
            	}else if(row.lt==3){
            		show_name='信<i class="g-dian">·</i>赎楼贷';
            	}else if(row.lt==4||row.lt==7||row.lt==11){
					var con_type_name=row.sn.substring(1,3);
            		show_name='信<i class="g-dian">·</i>消费'+con_type_name;
            	}else if(row.lt==5){
            		show_name='信<i class="g-dian">·</i>精选贷';
            	}else if(row.lt==6){
            		show_name='信<i class="g-dian">·</i>质抵贷';
            	}else if(row.lt==8){
            		show_name='品<i class="g-dian">·</i>融360';
            	}else if(row.lt==9){
            		show_name='品<i class="g-dian">·</i>吉屋网';
            	}else if(row.lt==10){
            		show_name='信<i class="g-dian">·</i>优资贷';
            	}else if(row.lt==12){
            		show_name='品<i class="g-dian">·</i>保理贷';
            	}else if(row.lt==13){
            		show_name='品<i class="g-dian">·</i>分期X';
            	}else if(_d.lt==14){
                   show_name='信<i class="g-dian">·</i>消费JS';
                }else if(_d.lt==15){
                   show_name='品<i class="g-dian">·</i>票据贷';
                }else if(_d.lt==16){
                    show_name='信<i class="g-dian">·</i>车贷';
                } else if(_d.lt==17){
                    show_name='品<i class="g-dian">·</i>明特';
                }

            	var sn=AA.Helper.subInvestSn(row.sn);

            	l_href='/2.0/detail.shtml?sid='+row.sid;

                _body_html +=
                     '<tr>\
                       <td style="width:140px;" class="first"><a href="' + l_href + '" data-lid="' + row.lid + '" target="_blank">' + show_name + '-' + sn + '</a></td>\
                       <td style="width:115px;">' + AA.Helper.date(row.cTime ,'Y-m-d h:m:s') + '</td>\
                       <td style="width:90px;" class="g-money"><span class="g-out">' + row.money + '</span>  元</td>\
                       <td style="width:60px;">' + row.deadline + '</td>\
                       <td style="width:60px;">' + row.rate + '%</td>\
                       <td style="width:70px;" class="g-money"><a href="javascript:;" title="查看收益详情" rel="income-detail" data-lid="' + row.lid + '"><strong>' + row.rMoney + '</strong> 元</a></td>\
                       <td  style="width:80px;width:57px;">'+row.reward+'元</td>\
                       <td>' + AA.Helper.date(row.rTime ,'Y-m-d') + '</td>\
                       <td>' + AA.Api.Loan.status[row.rStatus] + '</td>\
                    </tr>';
            });

            body.html(_body_html);
        } ,
        /**
         * 日期选择器
         * @param cb
         */
        datepicker:function (cb) {
            var _stime = $.trim($('#s-time').val()),
                _etime = $.trim($('#e-time').val());
//			console.log("stime["+_stime+"],etime["+_etime+"]");
            if (_stime != '') {
                $('#stime').val(AA.Helper.timespan(_stime + ' 00:00:00'));
            }

            if (_etime != '') {
                $('#etime').val(AA.Helper.timespan(_etime + ' 23:59:59'));
            }
            cb && cb(1);
        } ,
        /**
         * 账户首页
         */
        Index:{
            init:function () {

                //用户账户信息
                AA.User.Index.getAccountinfo();
                //最近投资记录
                /*AA.User.renderView({
                    data:{perNum:5},
                    api:AA.Api.User.refundInfo
                });*/
                load_near_refund_list(1);
            } ,
            getAccountinfo:function () {
                AA.Api.User.accountInfo({} ,function (result) {
                    if (result.state == 1) {
                        var _d = result.data;
                        $('.tInvest').html(_d.tInvest);
                        $('.tNum').html(_d.tNum);
                        $('.tEarn').html(_d.tEarn);
                        $('.nNum').html(_d.nNum);

                        if (_d.oNum > 0) {
                            $('.oNum').html('，' + _d.oNum);
                            $('.overdue').show();
                        }

                    }
                });

                AA.Api.async({
                    url:'/v2/member/get_asset_overview.jso' ,
                    type:'GET' ,
                    data:'' ,
                    success:function(result){

                    	var all=Number(result.accountBalance)+Number(result.xcbTotalMoney)+Number(result.rewardMoney)+Number(result.earning)+Number(result.moneyWithdraw)+Number(result.overdue);

                    	$('#all').html(AA.Helper.commafy(AA.Helper.toCent(all)));
                    	$('#t_money').html(AA.Helper.commafy(AA.Helper.toCent(result.accountBalance)));
                    	$('#xcb_money').html(result.xcbTotalMoney);
                    	$('#all_reward').html(AA.Helper.commafy(AA.Helper.toCent(result.rewardMoney)));
                    	$('#earn').html(AA.Helper.commafy(AA.Helper.toCent(result.earning)));
                    	$('#withdraw').html(AA.Helper.commafy(AA.Helper.toCent(result.moneyWithdraw)));
                    	$('#overdue').html(AA.Helper.commafy(AA.Helper.toCent(result.overdue)));
                    }
                });

                AA.Api.async({
                	 url:'/v2/member/get_invest_income_statistics.jso' ,
                     type:'GET' ,
                     data:'' ,
                     success:function(result){

                    	 $('#earn_recharge_recharge').html(AA.Helper.commafy(AA.Helper.toCent(result.recharge)));
                    	 $('#earn_recharge_ct').html(result.rechargeNum);


                    	$('#earn_withdraw_withdraw').html(AA.Helper.commafy(AA.Helper.toCent(result.withdraw)));
                     	$('#earn_withdraw_ct').html(result.withdrawNum);
                     	$('#earn_withdraw_fee').html(AA.Helper.commafy(AA.Helper.toCent(result.withdrawFee)));


                     	$('#earn_invest_invest').html(AA.Helper.commafy(AA.Helper.toCent(result.invest)));
                    	$('#earn_invest_ct').html(result.investNum);
                    	$('#earn_invest_ag').html(AA.Helper.commafy(AA.Helper.toCent(result.investAvg)));

                    	var earn_all=Number(result.receivedRetain)+Number(result.profitingRetain)+Number(result.deductedReward);

                    	$('#earn_all').html(AA.Helper.commafy(AA.Helper.toCent(earn_all)));

                    	$('#earn_back').html(AA.Helper.commafy(AA.Helper.toCent(result.receivedRetain)));

                    	$('#earn_earn').html(AA.Helper.commafy(AA.Helper.toCent(result.profitingRetain)));

                    	$('#reward_use').html(AA.Helper.commafy(AA.Helper.toCent(result.deductedReward)));
                     }
                });

            }
        } ,
        /**
         * 投资管理
         */
        Invest:{
            init:function () {
                //投资收益统计
                var _api = AA.Api.User,
                    _load = AA.User.Invest.load;

                AA.Api.async({
                	 url:'/v2/member/get_invest_management_ex.jso' ,
                     type:'GET' ,
                     data:'' ,
                     success:function(result){
                	 	if(result.state == 1009){
                            AA.RapidLogin.popup();
                            return;
                     	}
                		$('#invest_num').html(result.investNum);
                    	$('#invest_all_money').html(AA.Helper.commafy(AA.Helper.toCent(result.investSum)));

                    	$('#refund_all').html(AA.Helper.commafy(AA.Helper.toCent(result.profitingSum)));
                    	$('#refund_money').html(AA.Helper.commafy(AA.Helper.toCent(result.profitingMoney)));
                    	$('#refund_retain').html(AA.Helper.commafy(AA.Helper.toCent(result.profitingRetain)));

                    	if(result.upComingTime==null||result.upComingTime==undefined){
                    		$('#refund_near_day').html('暂无');
                    		$('#refund_near_money').html(0);
                    	}else{
                    		$('#refund_near_day').html(result.upComingTime);
                    		$('#refund_near_money').html(AA.Helper.commafy(AA.Helper.toCent(result.upComingMoney)));
                    	}

                    	$('#earning_all').html(AA.Helper.commafy(AA.Helper.toCent(result.profitingSum)));
                    	$('#earning_ct').html(result.profitingNum);
                    	$('#earning_money').html(AA.Helper.commafy(AA.Helper.toCent(result.profitingMoney)));
                    	$('#earning_retain').html(AA.Helper.commafy(AA.Helper.toCent(result.profitingRetain)));

                    	$('#earn_all').html(AA.Helper.commafy(AA.Helper.toCent(result.receivedSum)));
                    	$('#earn_money').html(AA.Helper.commafy(AA.Helper.toCent(result.receivedMoney)));
                    	$('#earn_retain').html(AA.Helper.commafy(AA.Helper.toCent(result.receivedRetain)));
                    	$('#earn_ct').html(result.receivedNum);

                    	$('#overdue_all').html(AA.Helper.commafy(AA.Helper.toCent(result.overdueSum)));
                    	$('#overdue_money').html(AA.Helper.commafy(AA.Helper.toCent(result.overdueMoney)));
                    	$('#overdue_retain').html(AA.Helper.commafy(AA.Helper.toCent(result.overdueRetain)));
                    	$('#overdue_ct').html(result.overdueNum);

                    	$('#all_retain').html(AA.Helper.commafy(AA.Helper.toCent(result.totalInvestRetain)));
                    	$('#xcb_total_income').html(AA.Helper.toCent(result.xcbTotalIncome));
                    	$('#reward_use').html(AA.Helper.commafy(AA.Helper.toCent(result.deductReward)));
                    	$('#reward_out').html(AA.Helper.commafy(AA.Helper.toCent(result.outReward)));
                    	$('#all').html(AA.Helper.commafy(AA.Helper.toCent(result.totalRetain)));
                     }

                });

                //投资项目列表
                _load(1);

                $('#sl-time,#state,#order,#refundType').change(function () {
                    if (this.id == 'sl-time') {
                        if ($(this).val() != '3') {
                            $('.pk-time').hide();
                            $("#time").val($(this).val());
                            _load(1);
                        } else {
                            $('.pk-time').show();
                            $('#time').val('3');
                        }
                    } else {
                        _load(1);
                    }
                });

                $('.pk-time .ui-button').click(function () {
                    AA.User.datepicker(_load);
                });
                //	$('#s-time').blur(function(){AA.User.datepicker(function(){}) });
                //	$('#e-time').blur(function(){AA.User.datepicker(function(){}) });
            } ,
            load:function (pageIndex) {
                AA.User.renderView({
                        caption:'投资项目' ,
                        displays:['投资项目','投资时间','投资金额','期限','预期年化收益率','到期实收收益','回款日期','回款方式','状态',' &nbsp;&nbsp;操作   '] ,
                        fields:['title','odate','money g-money','deadline','rate','gains g-money','idate','refund_type','state','contract'] ,
                        data:{
                            pageIndex:pageIndex ,
							pageSize:10,
                            time:$('#time').val() ,
                            startTime:$('#stime').val()||0 ,
                            endTime:$('#time').val()==3?$('#etime').val()||parseInt((new Date()).valueOf()/1000):$('#etime').val()||0 ,
                            state:$('#state').val() ,
                            i_order:$('#order_time').val(),
                            refundType:$('#refundType').val()
                        } ,
                        render:function (rows ,body) {
                            var _body_html = '';
                            
                            var count = 0;
                            var invest = 0;
                            var earn = 0;
                            
                            $.each(rows ,function (index ,row) {
                            	var sd='个月';
                            	if(row.type==0){
                            		sd='日';
                            	}
                            	var show_title='信·无忧贷-'+row.sn.substr(3);
                            	var show_name=AA.Lang.PRODUCT_NAME;
                            	if(row.loanType==2){
                            		show_name='信<i class="g-dian" >·</i>优企贷';
                            		show_title='信·优企贷-'+row.sn.substr(3);
                            	}else if(row.loanType==3){
                            		show_name='信<i class="g-dian">·</i>赎楼贷';
                            		show_title='信·赎楼贷-'+row.sn.substr(3);
                            	}else if(row.loanType==4||row.loanType==7||row.loanType==11){
									var con_type_name=row.sn.substring(1,2);
                            		show_name='信<i class="g-dian">·</i>消费贷';
                            		show_title='信·消费'+con_type_name+'-'+row.sn.substr(3);
                            	}else if(row.loanType==5){
                            		show_name='信<i class="g-dian">·</i>精选贷';
                            		show_title='信·精选贷-'+row.sn.substr(3);
                            	}else if(row.loanType==6){
                            		show_name='信<i class="g-dian">·</i>质抵贷';
                            		show_title='信·质抵贷-'+row.sn.substr(3);
                            	}else if(row.loanType==8){
                            		show_name='品<i class="g-dian">·</i>融360';
                            		show_title='品·融360-'+row.sn.substr(3);
                            	}else if(row.loanType==9){
                            		show_name='品<i class="g-dian">·</i>吉屋网';
                            		show_title='品·吉屋网-'+row.sn.substr(3);
                            	}else if(row.loanType==10){
                            		show_name='信<i class="g-dian">·</i>优资贷';
                            		show_title='信·优资贷-'+row.sn.substr(3);
                            	}else if(row.loanType==12){
                            		show_name='品<i class="g-dian">·</i>保理贷';
                            		show_title='品·保理贷-'+row.sn.substr(3);
                            	}else if(row.loanType==13){
                            		show_name='品<i class="g-dian">·</i>分期X';
                            		show_title='品·分期X-'+row.sn.substr(3);
                            	}else if(row.loanType==15){
                            		show_name='品<i class="g-dian">·</i>票据贷';
                            		show_title='品·票据贷-'+row.sn.substr(3);
                            	}else if(row.loanType==16){
                            		var con_type_name=row.sn.substring(1,2);
                            		show_name='信<i class="g-dian">·</i>车贷';
                            		show_title='信·车贷'+con_type_name+'-'+row.sn.substr(3);
                            	}else if(row.loanType==17){
                                    show_name='品<i class="g-dian">·</i>明特';
                                    show_title='品·明特-'+row.sn.substr(3);
                                }

                            	var sn=AA.Helper.subInvestSn(row.sn);

                            	var show_trans='';

                            	if(row.deadline>=2){
                            		if(row.r_Status==1){
                            			if(row.transferStatus==-1){
                            				show_trans='<a style="padding-left:3px;" href="javascript:AA.User.Trans.trans(' + row.loanId + ',' + row.loanType +',\''+row.sn+'\','+row.deadline+');">转让</a>';
                            			}
                            		}
                            		if(row.transferStatus!=-1){
                        				show_trans='<a style="padding-left:3px;" href="javascript:AA.User.Invest.transfer_detail_show('+row.loanId+',' + row.loanType +',\''+row.sn+'\');">详情</a>';
                        			}
                            	}

                            	var dl = row.deadlineStr;;
                            	var rw=row.reward+'元';
                            	if(row.projectType==1){
                            		rw='0.00元';
                            	}

                            	l_href='/2.0/detail.shtml?sid='+row.sectionId;

                            	var refund_type=AA.Api.Loan.refundType[row.refundType];

                            	if(row.refundType!=1 && row.refundType!=5){
                            		refund_type="<a onclick='javascript:AA.User.Invest.refund_plan_show_avoid_double_click("+row.loanId+","+row.sn.substr(3)+","+row.refundType+","+row.loanType+",this"+","+row.rate+",\""+row.deadlineStr+"\");'>"+refund_type+"</a>";
                            	}
                            	/*if(row.refundType==2 || row.refundType==6){
                            		refund_type="<a href='javascript:AA.User.Invest.refund_plan_show("+row.loanId+","+row.sn.substr(3)+","+row.refundType+","+row.loanType+");'>等额本息</a>";
                            	}else if(row.refundType==4 || row.refundType==8){
                            		refund_type="<a href='javascript:AA.User.Invest.refund_plan_show("+row.loanId+","+row.sn.substr(3)+","+row.refundType+","+row.loanType+");'>按月付息</a>";
                            	}else if(row.refundType==3 || row.refundType==7){
                            		refund_type="<a href='javascript:AA.User.Invest.refund_plan_show("+row.loanId+","+row.sn.substr(3)+","+row.refundType+","+row.loanType+");'>等额本金</a>";
                            	}*/

                            	var _rTime;
    							/*if(row.l_Status == 3 || row.l_Status == 4){
    								_rTime = row.p_Time;
    							}else{
    								_rTime = row.r_Time;
    							}*/
    							_rTime = row.p_Time;
    							var eswIcon = '';
    							if(row.eswType == 1){
    								eswIcon = '<i class="escrow" title="江西银行存管">存管</i>';
    							}
                                if(row.loanId>0){
                                _body_html +=
                                    '<tr>\
                                        <td  style="width:145px;padding-left: 5px;"><a title="'+show_title+'" href="' + l_href + '" data-lid="' + row.loanId + '" target="_blank" >' + show_name + '-' + sn + '</a>'+eswIcon+'</td>\
                                        <td style="width:100px;">' + AA.Helper.date(row.i_Time ,'Y-m-d h:m:s') + '</td>\
                                        <td  class="g-money"  style="width:60px;text-align: center !important;"><span class="g-out">' + toDecimal(row.money) + '</span> 元</td>\
                                        <td style="width:50px;">' + dl +'</td>\
                                        <td style="width:80px;">' + row.rate + '%</td>\
                                        <td class="g-money" style="width:70px;"><a href="javascript:;" title="查看收益详情" rel="income-detail" data-lid="' + row.loanId + '"><strong>' + toDecimal(row.investRetain) + '</strong> 元</a></td>\
                                        <td style="width:100px;">' + AA.Helper.date(_rTime ,'Y-m-d') + '</td>\
                                        <td style="width:80px;">'+refund_type+'</td>\
                                        <td style="width:58px;">' + AA.Api.Loan.status[row.r_Status] + '</td>\
                                        <td style="width:58px;text-align: center !important;"> \
                                        <a href="javascript:AA.User.getContract('+row.loanId+')" class="PositionR hetong">合同 <span class="i-title"><b><img src="/2.0/images/bicon08.png"></b>可前往E签宝官网上传PDF文件获取“合同”验签结果</span></a> \
                                        '+show_trans+'</td> \
                                    </tr>';
                                }
                                else
                                {
                                    _body_html +=
                                        '<tr>\
                                            <td  style="width:130px;"><a title="'+show_title+'" href="' + l_href + '" data-lid="' + row.loanId + '" target="_blank" >' + show_name + '-' + sn + '</a></td>\
                                            <td style="width:100px;">' + AA.Helper.date(row.i_Time ,'Y-m-d h:m:s') + '</td>\
                                            <td  class="g-money"  style="width:60px;text-align: center !important;"><span class="g-out">' + parseInt(row.money) + '</span> 元</td>\
                                            <td style="width:50px;">' + dl +'</td>\
                                            <td style="width:80px;">' + row.rate + '%</td>\
                                            <td class="g-money" style="width:70px;"><a href="javascript:;" title="查看收益详情" rel="income-detail" data-lid="' + row.loanId + '"><strong>' + toDecimal(row.investRetain) + '</strong> 元</a></td>\
                                            <td style="width:100px;">' + AA.Helper.date(_rTime ,'Y-m-d') + '</td>\
                                            <td style="width:80px;">'+refund_type+'</td>\
                                            <td style="width:58px;">' + AA.Api.Loan.status[row.r_Status] + '</td>\
                                            <td style="width:58px;text-align: center !important;"><a href="' + AA.Helper.buildUrl('contract/api_loan?lid=' + row.loanId) + '" target="_blank" class="PositionR hetong">合同<span class="i-title"><b><img src="/2.0/images/bicon08.png"></b>可前往E签宝官网上传PDF文件获取“合同”验签结果</span></a>'+show_trans+'</td>\
                                        </tr>';
                                }
                                
                                count += 1;
                                invest += parseFloat(toDecimal(row.money));
                                earn += parseFloat(toDecimal(row.investRetain));
                            });

                            body.html(_body_html);
                            
                            var h='&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当页统计：共 <strong class="g-out">' + count + '</strong> 笔投资记录，投资总额合计<strong class="g-out">' + toDecimal(invest||0) + '</strong> 元，到期实收收益合计 <strong class="g-out">' + toDecimal(earn||0) + '</strong> 元';
                            $('#show_stat').html(h);
                        }
                    } ,function (result) {
                        if (result.state == 1) {
                            var _d = result.data;
                            $('.wgt-pagination').pagination({
                                'pageSize':10 ,
                                'total':_d.count ,
                                'showInfo':'' ,
                                'pageIndex':pageIndex ,
                                'callback':'AA.User.Invest.load'
                            });

                           //var h='&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;共 <strong class="g-out">' + _d.count + '</strong> 笔投资记录：投资总额合计<strong class="g-out">' + toDecimal(_d.invest||0) + '</strong> 元，到期实收收益合计 <strong class="g-out">' + toDecimal(_d.earn||0) + '</strong> 元';
                           //var h='&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;共 <strong class="g-out">' + _d.count + '</strong> 笔投资记录：投资总额合计<strong class="g-out">' + toDecimal(_d.invest||0) + '</strong> 元';
                           
                           //h=h+'投资奖励合计<strong class="g-out">'+toDecimal(_d.reward||0)+'</strong> 元。';

                           //$('#show_stat').html(h);

                            var _i_desc=$('#order_time').val();

                            var  _order ='';

                            if(_i_desc=='2'){
                            	_order= ' asc' ;
                            }else if(_i_desc=='1'){
                            	_order= ' desc' ;
                            }

                            $i_time = $('.wgt-datagrid th.odate');
                            $i_time.wrapInner('<a href="javascript:;" class="order1' + _order + '" hidefocus="true"/>');
                            $order = $i_time.find('.order1');
                            $i_time.bind('click' ,function () {
                            	if ($order.hasClass('asc')) {
                                    $order.removeClass('asc');
                                    $('#order_time').val('1');
                                } else if ($order.hasClass('desc')) {
                                    $order.removeClass('desc').addClass('asc');
                                    $('#order_time').val('2');
                                } else {
                                    $order.addClass('desc');
                                    $('#order_time').val('1');
                                }

                            	AA.User.Invest.load(1);
                            });

                            var _r_desc=$('#order_time').val();

                            var  _r_order ='';

                            if(_r_desc=='4'){
                            	_r_order= ' asc' ;
                            }else if(_r_desc=='3'){
                            	_r_order= ' desc' ;
                            }

                            $r_time = $('.wgt-datagrid th.idate');
                            $r_time.wrapInner('<a href="javascript:;" class="order' + _r_order + '" hidefocus="true"/>');
                            $r_order = $r_time.find('.order');
                            $r_time.bind('click' ,function () {
                            	if ($r_order.hasClass('asc')) {
                            		$r_order.removeClass('asc');
                                    $('#order_time').val('3');
                                } else if ($r_order.hasClass('desc')) {
                                	$r_order.removeClass('desc').addClass('asc');
                                    $('#order_time').val('4');
                                } else {
                                	$r_order.addClass('desc');
                                    $('#order_time').val('3');
                                }

                            	AA.User.Invest.load(1);
                            });
                        }
                    }
                );
            },
            //点击 后a链接 失效2秒
            refund_plan_show_avoid_double_click:function(loan_id,sn,refund_type,loan_type,target,rate,deadlineStr){


                var isEnable = target.getAttribute("isEnable");
                if (isEnable=="NO"){
                    return false;
                }
                target.setAttribute("isEnable","NO");
                setTimeout(setEnable,1000);

                function setEnable() {
                    target.setAttribute("isEnable","YES");
                }



                AA.User.Invest.refund_plan_show(loan_id,sn,refund_type,loan_type,rate,deadlineStr);
            }
            ,
            refund_plan_show:function(loan_id,sn,refund_type,loan_type,rate,deadlineStr){
            	AA.Api.User.refundPlanInfo({loanId:loan_id},function(result){
            		if(result.state==0){
            			Xinrong_RefundPlan.initData(result,sn,refund_type,loan_type,rate,deadlineStr);
            		}
            	});
            },
            transfer_detail_show:function(loanId,loan_type,sn){
            	TransDetail.initData(loanId,sn,loan_type);
            }
        } ,
        /**
         * 充值
         */
        Recharge:{
            init:function () {
                var $money = $('#money');
                $money.focus();

                var url = location.search; // 获取url中"?"符后的字串 从信融花花中的充值跳过来时   显示连连快捷充值
                var theRequest = new Object();
                if (url.indexOf("?") != -1) {
                    var str = url.substr(1);
                        strs = str.split("&");
                        for ( var i = 0; i < strs.length; i++) {
                            theRequest[strs[i].split("=")[0]] = decodeURIComponent(strs[i].split("=")[1]);
                        }
                        if(theRequest['type']!=undefined&&theRequest['type']!=null){
                            if(theRequest['type']=='refund'){
                                $('#lianfastpay1').show();
                                $('#quickRef').attr("href","/my/rechargecrefund?type=refund");
                                $('#bankRef').attr("href","/my/rechargerefund?type=refund");
                                var objOption = new Option("连连小额支付","lianfastpaywap"); 
                                var objSelect=document.getElementById("bank_type_select");  
                                if(objSelect!=null){
                                    objSelect.add(objOption, 1);
                                }
                                
                            }
                        }   
                }

                if (!AA.Api.User.isAuth) {
                    AA.RapidLogin.popup();
                }

                AA.Api.async({
           		 url:'loan/get_next_section_time' ,
           		success:function(result){

           			if(result.state==0&&result.ct==0){
           				$('#recharge_no_loan_alert').show();
           			}
           		}
                });


                $('.banks-panel img').click(function () {
                    $(this).prev('input').attr('checked' ,true);
                });

                $money.blur(function () {
                    //小数点处理
                    var _val = $.trim($money.val());
                    if (_val == '' || _val == '0' || isNaN(_val)) {
                        _val = '';
                    } else {
                        _val = AA.Helper.formatDecimals(_val);
                    }
                    $money.val(_val);
                });

               /* $('#recharge-form .ui-button').click(function () {
                	$.ajax({
            			url:'/v2/login/in_session_data.jso',
    					async:false,
            		    type:'GET' ,
            		    dataType:'json',
            		    success:function (result) {
            				if(result.state==0){
            					alert('1');
            				}else if(result.state==1009){
            					 AA.RapidLogin.popup();
            					 return false;
            				}else{
            					alert('3');
            				}
            			}
            		});
                }
                   );*/
                
                $('#recharge-form' ).submit(function () {
                    	var state=null;
                    	$.ajax({
                			url:'/v2/login/in_session_data.jso',
        					async:false,
                		    type:'GET' ,
                		    dataType:'json',
                		    success:function (result) {
                		    	state=result.state;
                				
                			}
                		});
                    	if(state==0){
                    		 var _money = $.trim($money.val()),
                             _lowest_pay = $("#lowest_pay").val(),
                             _banks = $('input[name^="bank_name"]:checked'),
                             _warning = AA.User.warning,
                             _success = AA.User.success,
                             _tip_money = $money.nextAll('em'),
                             _bankName = '';
                    		 
                    		 if (_money == '') {
                                 $money.focus();
                                 return _warning(_tip_money ,'请填写充值金额');
                             } else {
                                 _success(_tip_money);
                             }

                             if (!/^\d+(\.\d+)?$/.test(_money)) {
                                 $money.focus();
                                 return _warning(_tip_money ,'金额格式不正确');
                             } else {
                                 _success(_tip_money);
                             }

                             if (parseFloat(_money) < parseFloat(_lowest_pay)) {
                                 $money.focus();
                                 return _warning(_tip_money ,'单笔应不低于' + _lowest_pay + '元');
                             } else {
                                 _success(_tip_money);
                             }

                             if (parseFloat(_money) > 10000000) {
                                 $money.focus();
                                 return _warning(_tip_money ,'单笔不能高于10,000,000.00元');
                             } else {
                                 _success(_tip_money);
                             }
                             
                             _bankName = '';
                             $.alert({
                                 tipCls:'info' ,
                                 padding:'50px 0 0 60px' ,
                                 title:'请在新开的' + _bankName + '页面完成支付后再选择。<a href="' + AA.Helper.buildUrl('help/faq') + '/1#16" class="blue" target="_blank">充值遇到问题？</a>' ,
                                 txtBtn:'已完成充值' ,
                                 txtBtn1:'继续充值' ,
                                 url:'my/in' ,
                                 url1:'my/recharge'
                             });
                             $('.wgt-dialog-alert .wgt-dialog-title').css({'padding-left':'25px'});
                           
                    	}else if(state==1009){
                			AA.RapidLogin.popup();
                				return false;
                			}
                		else {
    						return false;}
                    });
            }
        } ,
        /**
         * 提现
         */
        Deposit:{
            init:function () {
                var $money = $('#money'),
                //常规手续费
                    _fee = parseFloat($('#curWithFee').val()),
                //活动资金
                    _hot_money = parseFloat($('#hot_money').val()),
                //额外手续费
                    _exra_fee = 0,
                //额外手续费率
                    _exra_rate = parseFloat($('.exra-rate').html()),
                //应付总额
                    _total_due;

                if (!AA.Api.User.isAuth) {
                    AA.RapidLogin.popup();
                }

                $money.focus();

                $('.general-fee').html(_fee);

                $money.focus(function () {
                    $money.val($money.val().replace('.00' ,''));
                });
                $('#auto_fill').bind('click',function(){
                    if (isCommitting == false) {
                         $('#auto_fill').html('计算中..');
                            isCommitting=true;
                            AA.Api.async({
                                url:'v2/withdraw/user_withdraw_info.jso' ,
                                type:'GET' ,
                                success:function(result){
                                    if (result.state==0) {
                                        $('#auto_fill').html('自动填写');
                                        isCommitting=false;
                                        if (result.maxMoneyCanExc !=null) {
                                            if (result.maxMoneyCanExc < 0) {
                                                result.maxMoneyCanExc=0;
                                                }
                                            $('#money').val(result.maxMoneyCanExc);
                                            $.ajax({
                                                url : '/v2/withdraw/calculate_fee.jso',
                                                type : 'post',
                                                data:{money:result.maxMoneyCanExc},
                                                dataType : 'json',
                                                success : function(data) {
                                                    if(data.state == 0){
                                                        $("#extra_fee_view").hide();
                                                        var totalMoney = data.totalMoney;
                                                        var extraFee = data.extraFee;
                                                        var fee = data.fee;
                                                        var totalFee = parseInt((parseFloat(extraFee)+parseFloat(fee))*100)/100;
                                                        $('.fee-tip').show();
                                                        $('.extra-fee').html('');
                                                        $('.general-fee').html('' );
                                                        if(extraFee > 0){ 
                                                            $('.extra-fee').html(',额外手续费' + AA.Helper.toFixed(extraFee) + '元');
                                                        }
                                                        if (fee > 0) {
                                                            $('.general-fee').html('含常规手续费' + fee + '元');    
                                                        }
                                                        if (extraFee ==0 && fee == 0)
                                                            $('.fee-tip').hide();                                                        
                                                        $('.total-due').html(totalMoney);
                                                        $money.nextAll('em').hide();
                                                        // $('.extra-fee').html('');
                                                        // //$('.general-fee').hide();
                                                        // $('.fee-tip').hide();
                                                    }else{//异常信息
                                                        AA.User.warning($money.nextAll('em') ,data.msg);;
                                                    }
                                                }
                                            });
                                        }
                                    }
                                    
                                }
                            })
                    }
                   
                });
                $money.keyup(function () {
                    //提现金额
                    _val = $.trim($money.val());

                    //非数字或0处理
                    if (isNaN(_val) || _val == 0) {
                        _val = 0;
                        $(this).val('');
                    } else {
                        _val = parseFloat(_val);

                        if (_val > _hot_money) {
                            _exra_fee = ((_val - _hot_money) * _exra_rate) / 100;
                            _exra_fee > 0 ? $('.extra-fee').html((_fee == 0 ? '' : '、') + '额外手续费' + AA.Helper.toFixed(_exra_fee) + '元') : $('.extra-fee').html('');
                        } else {
                            _exra_fee = 0;
                            $('.extra-fee').html('');
                        }
                    }

                    _val = _val < 0 ? 0 : _val;
                    if (_val == 0) {
                        $('.fee-tip').hide();
                        _total_due = '-';
                    } else {
                        _fee == 0 ? $('.general-fee').hide() : $('.general-fee').html('含常规手续费' + _fee + '元');
                        _fee == 0 && _exra_fee == 0 ? $('.fee-tip').hide() : $('.fee-tip').show();
                        _total_due = AA.Helper.toFixed(_val + _fee + _exra_fee-0.000001);
                    }

                    $('.total-due').html(_total_due); //提现金额 + 常规手续费 + 额外手续费

                    var _totalMoney = parseFloat($('#available_total_money').val());
                    if (_total_due > _totalMoney) {
                        $money.focus();
                        return AA.User.warning($money.nextAll('em') ,'应付总额已超出您的账户余额');
                    } else {
                    	$money.nextAll('em').hide();
                    }
                });

                $money.blur(function () {
                    //提现金额
                    _val = $.trim($money.val());

                    //非数字或0处理
                    if (isNaN(_val) || _val == 0) {
                        _val = 0;
                        $(this).val('');
                    } else {
                        //小数点处理
                        _val = AA.Helper.formatDecimals(_val);
                        $money.val(_val);

                        //是否需要收取额外手续费
                        if (_val > _hot_money) {
                            _exra_fee = ((_val - _hot_money) * _exra_rate) / 100;
                            _exra_fee > 0 ? $('.extra-fee').html((_fee == 0 ? '' : '、') + '额外手续费' + AA.Helper.toFixed(_exra_fee) + '元') : $('.extra-fee').html('');
                        } else {
                            _exra_fee = 0;
                            $('.extra-fee').html('');
                        }
                    }

                    _val = _val < 0 ? 0 : _val;
                    if (_val == 0) {
                        $('.fee-tip').hide();
                        _total_due = '-';
                    } else {
                        _fee == 0 ? $('.general-fee').hide() : $('.general-fee').html('含常规手续费' + _fee + '元');
                        _fee == 0 && _exra_fee == 0 ? $('.fee-tip').hide() : $('.fee-tip').show();
                        _total_due = AA.Helper.toFixed(_val + _fee + _exra_fee-0.000001);
                    }

                    $('.total-due').html(_total_due); //提现金额 + 常规手续费 + 额外手续费

                    var _totalMoney = parseFloat($('#available_total_money').val());
                    if (_total_due > _totalMoney) {
                        $money.focus();
                        return AA.User.warning($money.nextAll('em') ,'应付总额已超出您的账户余额');
                    } else {
                    	$money.nextAll('em').hide();
                    }
                });

                //提现申请
                $("#deposit-form .ui-button").click(function () {
                    var _deposit_dialog_html = $('#wgt-dialog-deposit-wrapper').html(),
                        _money = $.trim($money.val()),
                        _totalMoney = parseFloat($('#available_total_money').val()),
                        _warning = AA.User.warning,
                        _tip_money = $money.nextAll('em'),
                        _lowest_get = $("#lowest_get").val(),
                        _curWithLimit = parseFloat($("#curWithLimit").val()), //当日最大提现限额
                        _curWithMoney = parseFloat($('#curWithMoney').val()), //已提现金额
                        _limitMoney = _curWithLimit - _curWithMoney; //可提现金额

                    if (!AA.Api.User.isAuth) {
                        AA.RapidLogin.popup();
                        return false;
                    } /*else if (!G_ENV_VAR.IS_CHECKED_EMAIL) {
                        $.alert({
                            title:'您的邮箱尚未经过验证！' ,
                            content:'<span class="orange">友情提示：</span>完成邮箱验证后才可以提现。' ,
                            txtBtn:'立即验证' ,
                            url:'my/authinfo#email'
                        });
                        return false;
                    } */else if (!G_ENV_VAR.IS_CHECKED_MOBILE) {
                        $.alert({
                            title:'您的手机号尚未经过认证！' ,
                            content:'<span class="orange">友情提示：</span>完成手机认证后才可以提现。' ,
                            txtBtn:'立即认证' ,
                            url:'my/authinfo#mobile'
                        });
                        return false;
                    } else if (!G_ENV_VAR.HAS_TRADE_PASSWORD) {
                        $.alert({
                            title:'您尚未设置交易密码！' ,
                            content:'<span class="orange">友情提示：</span>设置交易密码后才可以提现。' ,
                            txtBtn:'立即设置' ,
                            url:'my/password#setsafe'
                        });
                        return false;
                    } else if (!G_ENV_VAR.IS_CHECKED_IDENTIFICATION) {
                        $.alert({
                            title:'您尚未进行实名认证，暂不能提现。' ,
                            content:'<span class="orange">友情提示：</span>完成实名认证和银行卡认证后才可以提现。' ,
                            txtBtn:'立即认证' ,
                            url:'my/authinfo#identity'
                        });
                        return false;
                    } else if (false/*!G_ENV_VAR.IS_CHECKED_BANKCARD*/) {
                        $.alert({
                            title:'您尚未进行银行卡认证，暂不能提现。' ,
                            content:'<span class="orange">友情提示：</span>完成银行卡认证后才可以提现。' ,
                            txtBtn:'立即认证' ,
                            url:'my/authinfo#bankcard'
                        });
                        return false;
                    }

                    if (_money == '') {
                        $money.focus();
                        return _warning(_tip_money ,'请填写提现金额');
                    } else {
                        _tip_money.hide();
                    }

                    if (!/^\d+(\.\d+)?$/.test(_money)) {
                        $money.focus();
                        return _warning(_tip_money ,'金额格式不正确');
                    } else {
                        _tip_money.hide();
                    }

                    if (parseFloat(_money) < parseFloat(_lowest_get)) {
                        $money.focus();
                        return _warning(_tip_money ,'单笔应不低于' + _lowest_get + '元');
                    } else {
                        _tip_money.hide();
                    }

                    /*if (parseFloat(_money) > _limitMoney) {
                        $money.focus();
                        return _warning(_tip_money ,'提现金额超过每日上限 <strong>' + _curWithLimit + '</strong> 元');
                    } else {
                        _tip_money.hide();
                    }*/

                    if (_total_due > _totalMoney) {
                        $money.focus();
                        return _warning(_tip_money ,'应付总额已超出您的账户余额');
                    } else {
                        _tip_money.hide();
                    }

                    $.dialog({
                        'title':'提现' ,
                        'padding':'0' ,
                        'content':_deposit_dialog_html ,
                        'initialize':function () {
                            var _dialog = this,
                                _input = $('#safepass'),
                                _form = $('#rapid-deposit-form'),
                                _btn_submit = _form.find('.ui-button'),
                                _lackBanlance = parseFloat(_totalMoney) < parseFloat(_money);

                            $('.wgt-dialog-title').html('提现至银行卡');
                            ;
                            $('.money-label').html('提现金额：')
                            _form.find('.money').html(_money);
                            _btn_submit.val('确定提现');

                            if((G_ENV_VAR.VIP||0)<= 1){
                            	AA.Api.async({
                            		url:'v2/member/get_user_mobile_voice_check_status.jso' ,
                                    type:'post' ,
                                    success:function(result){
                                    	if(result.state == 0 && result.data == 0){
                                    		$('.ui-form-pic-captcha').show();
                                    		$('.ui-form-mobile-captcha').show();
                                    		AA.temp = {};
                                    		AA.temp.getCaptche = (function(){
                                    			var seed=new Date().getTime();
												$('#captcha_pic').attr('src','/v2/login/get_captcha.raw?seed='+seed);
												$('#seed').val(seed);
                                    		});
                                    		$('#captcha_pic').unbind('click').click(function(){
												AA.temp.getCaptche();
											});
											AA.temp.getCaptche();
											AA.temp.showErrorMsg = (function(msg){
												$("#safepass").next('.ui-tip').addClass('error').html(msg);
											});
											AA.temp.clearErrorMsg = (function(msg){
												$("#safepass").next('.ui-tip').removeClass('error').html('');
											});
											AA.temp.sendMobileCaptcha = (function(){
												var captcha=$('#captcha').val();
												var seed = $('#seed').val();
												if(captcha.length!=4){
													AA.temp.showErrorMsg('请正确输入图形验证码');
													return;
												}

												AA.temp.clearErrorMsg();

												AA.Api.async({
				                            		url:'v2/login/get_mobile_captcha.jso' ,
				                                    type:'post' ,
				                                    data:{
														captcha:captcha,
														seed:seed
													},
				                                    success:function(result){
				                                    	if(result.state==0){
															AA.temp.countDownTime=120;
															AA.temp.countDownCaptcha();
															AA.temp.showVoiceTip();
														}else{
															AA.temp.countDownTime=0;
															if(result.state==1001||result.state==1009){
																_dialog.close();
                                            					AA.RapidLogin.popup();
															}else if(result.state==2010){
																AA.temp.showErrorMsg('图形验证码输入错误,请点击图形刷新重试');
															}else if(result.state==2019){
																AA.temp.showErrorMsg('等待120秒后再重试');
															}else{
																AA.temp.showErrorMsg('系统繁忙，稍后请重试');
															}
														}
				                                    }
				                                });
											});
											$('#send_voice').unbind("click").bind('click',function(){
												AA.temp.sendMobileCaptcha();
											});
											AA.temp.countDownCaptcha = (function(){
												if(AA.temp.countDownTime>0){
													AA.temp.countDownTime--;
													$('#send_voice').removeClass("ui-button-blue").addClass("ui-button-gray").val('(' + AA.temp.countDownTime + 's)重发');
													$('#send_voice').unbind("click");
													setTimeout("AA.temp.countDownCaptcha()", 1000);
												}else{
													AA.temp.countDownTime=120;
													$('#send_voice').removeClass("ui-button-gray").addClass("ui-button-blue").val('发送验证码');
													$('#send_voice').unbind("click").bind('click',function(){
														AA.temp.sendMobileCaptcha();
													});

													$('#captcha').val('');
													AA.temp.getCaptche();
												}
											});
											AA.temp.showVoiceTip = (function(){
												$('#voice_tip_view').show();
												setTimeout(function(){
													$('#voice_tip_view').hide();
												},100000);
											});
                                    	}else{
                                    		$('.ui-form-pic-captcha').hide();
                                    		$('.ui-form-mobile-captcha').hide();
                                    	}
                                    }
                            	});
                            }

                            AA.doPay({
                                lackBalance:_lackBanlance ,
                                callback:function (_val) {
                                	var mobileCaptcha = $('#mobile_captcha').val();
                                	AA.Api.async({
                                        url:'v2/withdraw/user_withdraw.jso' ,
                                        type:'GET' ,
                                        data:{money:_money,pass:AA.Helper.encrypPw(_val),mobileCaptcha:mobileCaptcha},
                                        success:function(result){
                                        	if(result.state==0){
                                        		 _dialog.close();
                                                 var _isVip = G_ENV_VAR.VIP != '0',
                                                     _content = '周一~周六15:30前提现，五大行可当天到账；<br />其他情况银行到账时间均以财付通具体时间为准。';

                                                 $.alert({
                                                     tipCls:'success1' ,
                                                     title:'提现申请已提交！' ,
                                                     content:_content ,
                                                     txtBtn:'账户首页' ,
                                                     url:'2.0/views/account/account_index.shtml'
                                                 });

                                                 $('.wgt-dialog-alert .ui-button-orange').after('<a class="blue" href="' + AA.Helper.buildUrl('my/deposit') + '">继续提现</a>');
//                                                 if (!_isVip) {
//                                                     $('.wgt-dialog-container').css({'padding-top':'30px'});
//                                                     $('.wgt-dialog-alert').append('<p class="ui-tip info" style="margin:20px 0 0 150px" target="_blank">VIP会员提现3小时即到账！<a href="' + AA.Helper.buildUrl('vip/') + '#opened" class="blue">立即开通</a></p>')
//                                                 }
                                        	}else if(result.state==1009){
                                        		_dialog.close();
                                                AA.RapidLogin.popup();
                                        	}else{
                                        		 _warning(_input.next('.ui-tip') ,result.msg);
                                        		 AA.Helper.enabled(_btn_submit);
                                                 _btn_submit.next('.ui-loading').hide();

                                                 _input.val("");
                                        	}
                                        }
                                    });

                                    /*AA.Api.Deposit.doAction({
                                        'money':_money ,
                                        'password':_val
                                    } ,function (result) {
                                        if (result.state == 1) {
                                            _dialog.close();
                                            var _isVip = G_ENV_VAR.VIP != '0',
                                                _content = '周一~周六15:30前提现，五大行可当天到账；其他情况银行到账时间均以财付通具体时间为准。';

                                            $.alert({
                                                tipCls:'success1' ,
                                                title:'提现申请已提交！' ,
                                                content:_content ,
                                                txtBtn:'账户首页' ,
                                                url:'my/'
                                            });

                                            $('.wgt-dialog-alert .ui-button-orange').after('<a class="blue" href="' + AA.Helper.buildUrl('my/deposit') + '">继续提现</a>');
                                            if (!_isVip) {
                                                $('.wgt-dialog-container').css({'padding-top':'35px'});
                                                $('.wgt-dialog-alert').append('<p class="ui-tip info" style="margin:30px 0 0 150px" target="_blank">VIP会员提现3小时即到账！<a href="' + AA.Helper.buildUrl('vip/') + '#opened" class="blue">立即开通</a></p>')
                                            }
                                        } else {

                                            if (result.error == 1009) {
                                                _dialog.close();
                                                AA.RapidLogin.popup();
                                            }else if(result.error == 2008){
                                            	 _warning(_input.next('.ui-tip') ,'交易密码错误');

                                            }else if(result.error == 2011){
                                            	 _warning(_input.next('.ui-tip') ,'提现金额不能大于提现每日上限');

                                            }else if(result.error == 2012){
                                            	 _warning(_input.next('.ui-tip') ,'提现金额不能大于用户余额');

                                            }else if(result.error == 2013){
                                            	 _warning(_input.next('.ui-tip') ,'提现金额不能小于最低提现金额');

                                            }else{
                                            	 _warning(_input.next('.ui-tip') ,'提现失败');
                                            }
                                            AA.Helper.enabled(_btn_submit);
                                            _btn_submit.next('.ui-loading').hide();

                                            _input.val("");
                                        }
                                    });*/
                                }
                            });
                        }
                    });
                });
            }
        } ,
        /**
         * 收支查询
         */
        Consume:{
            /**
             * 初始化事件
             * @param data
             */
            init:function (type) {
                var _load = AA.User.Consume[type].load;
                $('#ttime,#ttype').change(function () {
                    if (this.id == 'ttime') {
                        if ($(this).val() != '3') {
                            $("#time").val($(this).val())
                            $('.pk-time').hide();
                            _load(1);
                        } else {
                            $("#time").val('3');
                            $('.pk-time').show();
                        }
                    } else {
                        _load(1);
                    }
                });

                $('.pk-time .ui-button').click(function () {
                    AA.User.datepicker(_load);
                });
            } ,
            /**
             * 加载渲染数据
             * @param data
             */
            load:function (data) {
                var _type = data.type || AA.Api.User.ConsumeType.ALL,
                    _caption = data.caption || '收支明细',
                    _displays = data.displays || ['交易时间','交易类型','流水号','收入','支出','账户余额','备注'],
                    _fields = data.fields || ['date','type','sn','in g-money','out g-money','blance g-money','remark'],
                    _page_size = data.pageSize || 10,
                    _page_index = data.pageIndex || 1,
                    _callback = data.callback || 'Detail',
                    _render = data.render,
                    _ttype = parseInt($('#ttype').val());

                AA.User.renderView(
                    {
                        api:AA.Api.User.consumeInfo ,
                        caption:_caption ,
                        displays:_displays ,
                        fields:_fields ,
                        data:{
                            type:_type ,
                            perNum:_page_size ,
                            pageNum:_page_index ,
                            time:$('#time').val() ,
                            stime:$('#stime').val() ,
                            etime:$('#etime').val() ,
                            tType:_ttype
                        } ,
                        render:function (rows ,body) {
                            _render && _render(rows ,body);
                        }
                    } ,function (result) {
                        if (result.state == 1) {
                            var _d = result.data,
                                _type_label,
                                _money,
                                _sum_info;

                            if (_callback.toLowerCase() == 'detail') {//收支明细
                                if (_ttype == 0) {//收支明细
                                    _sum_info = '共 <strong class="g-out">' + _d.total + '</strong> 笔收支明细：收入 <span>'
                                        + _d.iNum + '</span> 笔，共 <strong class="g-out">'
                                        + _d.iMoney + '</strong> 元；支出 <span>'
                                        + _d.oNum + '</span> 笔，共 <strong class="g-out">'
                                        + _d.oMoney + '</strong> 元。';
                                } else {
                                    if (_ttype == 1) {//收入
                                        _type_label = '收入';
                                        _money = _d.iMoney;
                                    } else if (_ttype == 2) {//支出
                                        _type_label = '支出';
                                        _money = _d.oMoney;
                                    } else if (_ttype == 3) {//投资
                                        _type_label = '投资';
                                        _money = _d.oMoney;
                                    } else if (_ttype == 4) {//回款
                                        _type_label = '回款';
                                        _money = _d.iMoney;
                                    } else if (_ttype == 5) {//充值
                                        _type_label = '充值';
                                        _money = _d.iMoney;
                                    } else if (_ttype == 6) {//提现
                                        _type_label = '提现';
                                        _money = _d.oMoney;
                                    } else if (_ttype == 7) {//提现
                                        _type_label = '投资礼金';
                                        _money = _d.iMoney;
                                    }else if (_ttype == 8) {//支出
                                        _type_label = '投资服务费';
                                        _money = _d.oMoney;
                                    }
                                    _sum_info = '共 <strong class="g-out">' + _d.total + '</strong> 笔' + _type_label + '记录，共 <strong class="g-out">' + _money + '</strong> 元。';
                                }
                            } else {//充值\提现记录
                                _type_label = _callback.toLowerCase() == 'in' ? '充值' : '提现';
                                _sum_info = '共 <strong class="g-out">' + _d.total + '</strong> 笔' + _type_label + '记录，共 <strong class="g-out">' + _d.tMoney + '</strong> 元。';
                            }
                            $('.wgt-pagination').pagination({
                                'pageSize':_page_size ,
                                'total':_d.total ,
                                'showInfo':_sum_info ,
                                'pageIndex':_page_index ,
                                'callback':'AA.User.Consume.' + _callback + '.load'
                            });
                        }
                    }
                )
            } ,
            /**
             * 收支明细
             */
            Detail:{
                init:function () {
                	$('#ttime,#ttype').change(function(){
                        if (this.id == 'ttime') {
                            if ($(this).val() != '3') {
                                $('.pk-time').hide();
                                $("#time").val($(this).val());
                                AA.User.Consume.Detail.load(1);
                            } else {
                                $('.pk-time').show();
                                $('#time').val('3');
                            }
                        } else {
                        	AA.User.Consume.Detail.load(1);
                        }
                    });

        			$('.pk-time .ui-button').click(function(){
        				var _stime = $.trim($('#s-time').val());
                        var	_etime = $.trim($('#e-time').val());

	                    if (_stime != '') {
	                        $('#stime').val(AA.Helper.timespan(_stime + ' 00:00:00'));
	                    }

	                    if (_etime != '') {
	                        $('#etime').val(AA.Helper.timespan(_etime + ' 00:00:00')+86400);
	                    }

	                    /*if($('#stime').val()==0){
        					return;
        				}

        				if($('#etime').val()==0){
        					return;
        				}*/

        				AA.User.Consume.Detail.load(1);
        			});

        			AA.User.Consume.Detail.load(1);
                } ,
                load:function (pageIndex) {
                	$.ajax({
                		url:'/v2/member/income_and_expense_ext.jso',
                		type:'post',
                		dataType:'json',
                		data:{
                			pageSize:10,
            				pageIndex:pageIndex,
            				time:$('#time').val(),
            				type:$('#ttype').val(),
            				startTime:$('#stime').val()||0,
            				endTime:$('#etime').val()||0
                		},
                		success:function(result){
                			if(result.state == 0){
                				$('.wgt-datagrid-header').html('<tr>\
                						<th class="date first">交易时间</th>\
                						<th class="type">交易类型</th>\
                						<th class="sn">流水号</th>\
                						<th class="in g-money">收入</th>\
                						<th class="out g-money">支出</th>\
                						<th class="blance g-money">账户余额</th>\
                						<th class="remark last">备注</th>\
                						</tr>');
                				$('.wgt-datagrid-container').empty();

                				if(result.recordField.length == 0){
            						$('.wgt-datagrid-container').html('<tr><td colspan="7" class="wgt-datagrid-empty-row">暂无收支明细</td></tr>');
            						$('.wgt-pagination').hide();
            						return;
            					}

                				$.each(result.recordField,function(index,value){
            						var income = '';
            						var expense = '';
            						if(value.streamType == 1){
            							income = '<strong>+'+value.money+'</strong> 元';
            						}else{
            							expense = '<strong>-'+value.money+'</strong> 元';
            						}

            						var trClass = '';
            						if((index+1)%2 == 0){
            							trClass = ' class="odd"';
            						}
            						var $tr = '<tr'+trClass+'>'+
            								    '<td align="center">'+AA.Helper.date(value.ctime ,'Y-m-d h:m:s')+'</td>'+
            								    '<td align="center">'+AA.Helper.getTradeTypeStr(value.roleType,value.tradeType)+'</td>'+
            								    '<td align="center">'+value.sn+'</td>'+
            								    '<td align="center" class="g-money">'+income+'</td>'+
            								    '<td align="center" class="g-money">'+expense+'</td>'+
            								    '<td align="center">'+value.balanceMoney+' 元</td>'+
            								    '<td align="center">'+(value.note != null ? value.note : '')+'</td>'+
            								  '</tr>';

            						$('.wgt-datagrid-container').append($tr);
            					});

                				var count = 0;
            					var sum_income = 0;
            					var count_income = 0;
            					var sum_expense = 0;
            					var count_expense = 0;

            					$.each(result.countField,function(index,value){
            						count += value.count;
            						if(value.streamType == 1){
            							sum_income = value.sum;
            							count_income = value.count;
            						}
            						if(value.streamType == 2){
            							sum_expense = value.sum;
            							count_expense = value.count;
            						}
            					});

            					var $sum = '共 <b class="g-out">'+count+'</b> 笔收支明细：收入 '+count_income+' 笔，共 <b class="g-out">'+sum_income+'</b> 元；支出 '+count_expense+' 笔，共 <b class="g-out">'+sum_expense+'</b> 元。';
            					//$('.wgt-pagination-info').html($sum);

            					if(count>0){
            						$('.wgt-pagination').show();
            						$('.wgt-pagination').pagination({
            	                         'pageSize':10 ,
            	                         'total':count ,
            	                         'pageIndex':pageIndex ,
            	                         'showInfo':$sum ,
            	                         'callback':'AA.User.Consume.Detail.load'
            						});
            					}else{
                 					$('.wgt-pagination').hide();
                 				}
                			}else{
                				if(result.state == 1009){
                					AA.RapidLogin.popup();
                				}
                			}
                		}
                	});
                }
            } ,
            /**
             * 充值记录
             */
            In:{
                init:function () {
                    var _consume = AA.User.Consume;
                    _consume.init('In');
                    _consume.In.load();
                } ,
                load:function (pageIndex) {
                    AA.User.Consume.load({
                        caption:'充值记录' ,
                        displays:['充值时间','充值方式','流水号',' 充值金额','到账金额','手续费','状态'] ,
                        fields:['date','way','sn','recharge g-money','account g-money','fee','state'] ,
                        type:AA.Api.User.ConsumeType.IN ,
                        callback:'In' ,
                        pageIndex:pageIndex ,
                        render:function (rows ,body) {
                            var _body_html = '';
                            $.each(rows ,function (index ,row) {
                                _body_html +=
                                    '<tr>\
                                       <td class="first">' + AA.Helper.date(row.tTime ,'Y-m-d h:m:s') + '</td>\
                                       <td>'+ row.pType +'</td>\
                                       <td>' + row.sn + '</td>\
                                       <td class="g-money"><span class="g-out">' + row.money + '</span> 元</td>\
                                       <td class="g-money"><span class="g-out">' + row.rMoney + '</span> 元</td>\
                                       <td class="g-money">' + row.fee + ' 元</td>\
                                       <td>' + row.tType + '</td>\
                                    </tr>';
                            });
                            body.html(_body_html);
                        }
                    });
                }
            } ,
            /**
             * 提现记录
             */
            Out:{
                init:function () {
                    var _consume = AA.User.Consume;
                    _consume.init('Out');
                    _consume.Out.load();
                } ,
                load:function (pageIndex) {
                    AA.User.Consume.load({
                        caption:'提现记录' ,
                        displays:['申请提现时间','提现银行卡','流水号',' 提现金额','到账金额','手续费','状态'] ,
                        fields:['date','card','sn','deposit g-money','account g-money','fee','state'] ,
                        type:AA.Api.User.ConsumeType.OUT ,
                        callback:'Out' ,
                        pageIndex:pageIndex ,
                        render:function (rows ,body) {
                            var _body_html = '';
                            $.each(rows ,function (index ,row) {
                                _body_html +=
                                    '<tr>\
                                       <td class="first">' + AA.Helper.date(row.tTime ,'Y-m-d h:m:s') + '</td>\
                                       <td class="tl">' + row.bName + ' (尾号' + row.bNum + ')</td>\
                                       <td>' + row.sn + '</td>\
                                       <td class="g-money"><strong class="g-in">' + row.money + '</strong> 元</td>\
                                       <td class="g-money"><strong class="g-in">' + row.rMoney + '</strong> 元</td>\
                                       <td class="g-money">' + row.fee + ' 元</td>\
                                       <td>' + row.tType + '</td>\
                                    </tr>';
                            });
                            body.html(_body_html);
                        }
                    });
                }
            }
        } ,
        /**
         * 账户设置
         */
        Setting:{
            /**
             * 认证信息
             */
            AuthInfo:{
                init:function () {
                	location.href = '/2.0/views/account/account_settings.shtml';
                    var _authinfo = AA.User.Setting.AuthInfo;
                    //邮箱验证
                    $('.btn-email-auth').click(function () {
                        if (!AA.Api.User.isAuth) {
                            AA.RapidLogin.popup();
                        } else {
                            _authinfo.authEmail();
                        }
                    });

                    //手机认证
                    $('.btn-mobile-auth').click(function () {
                        if (!AA.Api.User.isAuth) {
                            AA.RapidLogin.popup();
                        } else if (!G_ENV_VAR.IS_CHECKED_EMAIL) {
                            $.alert({
                                title:'您尚未进行邮箱验证！' ,
                                content:'请先完成邮箱验证后再做手机认证。' ,
                                txtBtn:'邮箱验证' ,
                                url:'my/authinfo?_=' + (+new Date) + '#email'
                            });
                        }
                        else if (G_ENV_VAR.IS_CHECKED_MOBILE && !G_ENV_VAR.HAS_TRADE_PASSWORD) {
                            $.alert({
                                title:'您尚未设置交易密码！' ,
                                content:'必须先设置交易密码后才能修改手机号码' ,
                                txtBtn:'立即设置' ,
                                url:'my/password#setsafe'
                            });
                        } else {
                            _authinfo.authMobile();
                        }
                    });

                    //实名认证
                    $('.btn-identity-auth').click(function () {
                            if (!AA.Api.User.isAuth) {
                                AA.RapidLogin.popup();
                            } else if (!G_ENV_VAR.IS_CHECKED_EMAIL) {
                                $.alert({
                                    title:'您尚未进行邮箱验证！' ,
                                    content:'请先完成邮箱验证后再做实名认证。' ,
                                    txtBtn:'邮箱验证' ,
                                    url:'my/authinfo?_=' + (+new Date) + '#email'
                                });
                            }
                            else if (!G_ENV_VAR.IS_CHECKED_MOBILE) {
                                $.alert({
                                    title:'您尚未进行手机认证！' ,
                                    content:'请先完成手机认证后再做实名认证。' ,
                                    txtBtn:'手机认证' ,
                                    url:'my/authinfo?_=' + (+new Date) + '#mobile'
                                });
                            } else {
                                var _auth_number = parseInt($('#identity-auth-number').val()), //已认证次数
                                    _left_number = parseInt($('#identity-left-number').val()), //剩余次数
                                    _free_number = parseInt($('#identity-free-number').val()), //可免费认证次数
                                    _identity_fee = $('#identity-check-fee').val();             //费用

                                //认证次数超过3次进行扣费确认
                                if (_auth_number >= _free_number && _left_number < 1) {
                                    if (!G_ENV_VAR.HAS_TRADE_PASSWORD) {
                                        $.alert({
                                            title:'您尚未设置交易密码！' ,
                                            content:'请先设置交易密码后再做实名认证' ,
                                            txtBtn:'立即设置' ,
                                            url:'my/password#setsafe'
                                        });
                                    } else {
                                        AA.User.Setting.AuthInfo.identityPay();
                                        //AA.User.Setting.AuthInfo.payTip(AA.User.Setting.AuthInfo.identityPay, '实名认证', '您已超过 ' + _free_number + ' 次免费实名认证，重新认证将收取 ' + _identity_fee + ' 元手续费。')
                                        return false;
                                    }
                                }
                                else {
                                    _authinfo.authIDentity();
                                }
                            }
                        }
                    )
                    ;

                    //银行卡认证第一步
                    $('.btn-bankcard-auth').click(function () {
                        if (!AA.Api.User.isAuth) {
                            AA.RapidLogin.popup();
                        }
                        else if (!G_ENV_VAR.IS_CHECKED_EMAIL) {
                            $.alert({
                                title:'您尚未进行邮箱验证！' ,
                                content:'请先完成邮箱验证后再做银行卡认证。' ,
                                txtBtn:'邮箱验证' ,
                                url:'my/authinfo?_=' + (+new Date) + '#email'
                            });
                        }
                        else if (!G_ENV_VAR.IS_CHECKED_MOBILE) {
                            $.alert({
                                title:'您尚未进行手机认证！' ,
                                content:'请先完成手机认证后再做银行卡认证。' ,
                                txtBtn:'手机认证' ,
                                url:'my/authinfo?_=' + (+new Date) + '#mobile'
                            });
                        } else if (!G_ENV_VAR.IS_CHECKED_IDENTIFICATION) {
                            $.alert({
                                title:'您尚未进行实名认证！' ,
                                content:'请先完成实名认证后再做银行卡认证。' ,
                                txtBtn:'实名认证' ,
                                url:'my/authinfo?_=' + (+new Date) + '#identity'
                            });
                        } else if (G_ENV_VAR.IS_CHECKED_BANKCARD && !G_ENV_VAR.HAS_TRADE_PASSWORD) {
                            $.alert({
                                title:'您尚未设置交易密码！' ,
                                content:'必须先设置交易密码后才能修改银行卡信息' ,
                                txtBtn:'立即设置' ,
                                url:'my/password#setsafe'
                            });
                        }
                        else {
                            var _auth_number = parseInt($('#bankcard-auth-number').val()), //已认证次数
                                _left_number = parseInt($('#bankcard-left-number').val()), //剩余次数
                                _free_number = parseInt($('#bankcard-free-number').val()), //可免费认证次数
                                _bankcard_fee = $('#bankcard-check-fee').val(), //费用
                                _error;
                            //认证次数超过3次进行扣费确认
                            if (_left_number == 0) {
                                if (!G_ENV_VAR.HAS_TRADE_PASSWORD) {
                                    $.alert({
                                        title:'您尚未设置交易密码！' ,
                                        content:'请先设置交易密码后再做银行卡认证' ,
                                        txtBtn:'立即设置' ,
                                        url:'my/password#setsafe'
                                    });
                                } else {
                                    if ($('#bankcard-status').val() == '3') {
                                        _error = '您已超过 ' + _free_number + ' 次免费银行卡认证，重新认证将收取 ' + _bankcard_fee + ' 元手续费。';
                                        AA.User.Setting.AuthInfo.payTip(AA.User.Setting.AuthInfo.bankCardPay ,'银行卡认证' ,_error);
                                    } else {
                                        AA.User.Setting.AuthInfo.bankCardPay();
                                    }
                                    return false;
                                }
                            }
                            else {
                                if ($('#bankcard-status').val() == '3') {
                                    _error = '您还有 ' + _left_number + ' 次免费认证机会，超过 ' + _free_number + ' 次每次收取 ' + _bankcard_fee + ' 元手续费';
                                    AA.User.Setting.AuthInfo.payTip(AA.User.Setting.AuthInfo.authBankcard ,'银行卡认证' ,_error);
                                } else {
                                    _authinfo.authBankcard();
                                }
                            }
                        }
                    })
                    ;

                    //银行卡认证第二步
                    $('.btn-bankcard1-auth').click(function () {
                        if (!AA.Api.User.isAuth) {
                            AA.RapidLogin.popup();
                        } else {
                            _authinfo.authBankcard1();
                        }
                    });

                    $('#reauth').click(function () {

                    	 if (!AA.Api.User.isAuth) {
                             AA.RapidLogin.popup();
                         }
                         else if (!G_ENV_VAR.IS_CHECKED_EMAIL) {
                             $.alert({
                                 title:'您尚未进行邮箱验证！' ,
                                 content:'请先完成邮箱验证后再做银行卡认证。' ,
                                 txtBtn:'邮箱验证' ,
                                 url:'my/authinfo?_=' + (+new Date) + '#email'
                             });
                         }
                         else if (!G_ENV_VAR.IS_CHECKED_MOBILE) {
                             $.alert({
                                 title:'您尚未进行手机认证！' ,
                                 content:'请先完成手机认证后再做银行卡认证。' ,
                                 txtBtn:'手机认证' ,
                                 url:'my/authinfo?_=' + (+new Date) + '#mobile'
                             });
                         } else if (!G_ENV_VAR.IS_CHECKED_IDENTIFICATION) {
                             $.alert({
                                 title:'您尚未进行实名认证！' ,
                                 content:'请先完成实名认证后再做银行卡认证。' ,
                                 txtBtn:'实名认证' ,
                                 url:'my/authinfo?_=' + (+new Date) + '#identity'
                             });
                         } else if (G_ENV_VAR.IS_CHECKED_BANKCARD && !G_ENV_VAR.HAS_TRADE_PASSWORD) {
                             $.alert({
                                 title:'您尚未设置交易密码！' ,
                                 content:'必须先设置交易密码后才能修改银行卡信息' ,
                                 txtBtn:'立即设置' ,
                                 url:'my/password#setsafe'
                             });
                         }

                    	 var _auth_number = parseInt($('#bankcard-auth-number').val()), //已认证次数
                         _left_number = parseInt($('#bankcard-left-number').val()), //剩余次数
                         _free_number = parseInt($('#bankcard-free-number').val()), //可免费认证次数
                         _bankcard_fee = $('#bankcard-check-fee').val(), //费用
                         _error;



	                     //认证次数超过3次进行扣费确认
	                     if (_left_number == 0) {

	                         if (!G_ENV_VAR.HAS_TRADE_PASSWORD) {
	                             $.alert({
	                                 title:'您尚未设置交易密码！' ,
	                                 content:'请先设置交易密码后再做银行卡认证' ,
	                                 txtBtn:'立即设置' ,
	                                 url:'my/password#setsafe'
	                             });
	                         } else {

	                             if ($('#bankcard-status').val() == '3') {
	                                 _error = '您已超过 ' + _free_number + ' 次免费银行卡认证，重新认证将收取 ' + _bankcard_fee + ' 元手续费。';
	                                 AA.User.Setting.AuthInfo.payTip(AA.User.Setting.AuthInfo.bankCardPay ,'银行卡认证' ,_error);
	                             } else {
	                                 AA.User.Setting.AuthInfo.bankCardPay();
	                             }
	                             return false;
	                         }

	                     }



	                     if ($('#bankcard-status').val() == '3') {
                             _error = '您还有 ' + _left_number + ' 次免费认证机会，超过 ' + _free_number + ' 次每次收取 ' + _bankcard_fee + ' 元手续费';
                             AA.User.Setting.AuthInfo.payTip(AA.User.Setting.AuthInfo.authBankcard ,'银行卡认证' ,_error);
                         }

	                     _authinfo.authBankcardUpdate();

                    });


                    //收信地址
                    $('.btn-address-auth').click(function(){

                    	AA.User.Setting.AuthInfo.show_address_input();


                    });
                } ,

                show_address_input:function(data,addr){

                	if(data!=undefined&&data!=null){

                		AA.Address.init(data);
                	}else{
                		AA.Address.init();
                	}



               	 	$.alert({
    	                tipCls:'info1' ,
    	                padding:'25px 0 0 70px' ,

    	                height:'310px',
    	                title:'请输入您的收件信息',
    	                content:$('.wgt-dialog-address').html(),
    	                txtBtn:'下一步' ,
    	                init:function (d ,btn ,btn1) {

    	                	if(addr!=undefined){

    	                		$('#address').val(addr);
    	                	}

    	                	 btn.click(function () {


    	                		 if(check_address_input()){

    	                			 var addr=get_address_detail();

    	                			 var _province = $('#province option:selected').text();
    	                			 var _city = $('#city option:selected').text();
    	                			 var _district = $('#district option:selected').text();
    	                			 var _address = $.trim($('#address').val());

    	                			 var _consignee_zip=$.trim($('#consignee_zip').val());


    	                			 d.close();

    	                			 AA.User.Setting.AuthInfo.show_address_confirm(addr,_province,_city,_district,_address,_consignee_zip);

    	                		 }

    	                	 });

    	                }
    	           });
                },

                show_address_confirm:function(addr,_province,_city,_district,_address,_consignee_zip){

                	$.alert({

                		tipCls:'info1' ,

     	                title:'请确认您的收件信息',
     	                content:'<div style="line-height:35px;color: #333;"><p>'+addr+'</p></div>',
     	                txtBtn:'确定提交' ,
     	                txtBtn1:'返回修改' ,
     	                init:function (d ,btn ,btn1) {

     	                	 btn.click(function () {

     	                		 AA.Api.async({
     	                             url:'action/api_modify_address' ,
     	                             data:{province:_province,city:_city,district:_district,address:_address,zip:_consignee_zip},
     	                             success:function(result){

     	                            	 if(result.state==1){

     	                            		 d.close();

     	                            		window.location.reload();

     	                            	 }else{

     	                            	 }
     	                             }
     	                         });
     	                	 });
     	                	 btn1.click(function () {

     	                		 d.close();

     	                		 AA.User.Setting.AuthInfo.show_address_input(null,addr);

    	                	 });
     	                }

                	});
                },

                send_code_check:function(t_code,mobile){
                		var t=0;
                		if(is_reSendSms){
                			t=1;
                		}

                    	 AA.Api.async({
                             url:'my/api_send_mobile_check_code' ,
                             data:{type:t,t_code:t_code,m:mobile},
                             success:function(result){

                            	 if(result.state==0){
                            		 if(t_code==null||t_code==undefined){
                            			 AA.User.Setting.AuthInfo.modifyBankcardCountDown(120);
                            		 }

                            	 }else{

                            		 AA.User.warning($('#lbl-code-tip'),'短信发送失败');
                            	 }
                             }
                         });
                    	 is_reSendSms=true;
                },
                modifyBankcard1_check:function(){
                	var tip=$('#lbl-all-tip');

                	var i_real_name=$('#i_realname').val();

                	if(!isNaN(i_real_name.charAt(0)) || AA.Helper.getLength(i_real_name) < 4){
                		return AA.User.warning(tip ,'真实姓名格式不正确');
                	}

                	var i_id_num=$('#id_num').val();
                	var result = AA.Validator.checkIDCard(i_id_num);
                     if (result != '1') {
                         return AA.User.warning(tip ,result);
                     }

                    var i_mobile_num=$('#i_mobile_num').val();

                     if (!/^\d{6}$/.test(i_mobile_num)) {
                         return AA.User.warning(tip ,'验证码必须为6位数字');
                     }

                     tip.hide();

                     return true;
                },

                //银行卡修改步骤一下一步
                modifyBankcard1:function(){

                	var check_result=AA.User.Setting.AuthInfo.modifyBankcard1_check();

                	if(check_result){

                		 AA.Api.async({
                             url:'my/api_check_bankcard_modify_info' ,
                             data:{realname:$('#i_realname').val(),code:$('#i_mobile_num').val(),id:$('#id_num').val()},
                             success:function(result){

                            	 if(result.state==0){

                            		 AA.User.Setting.AuthInfo.authBankcardModify1();

                            	 }else{

                            		 var tip=$('#lbl-all-tip');
                            		 if(result.error==-2){
                            			 return AA.User.warning(tip ,'手机验证码错误');
                            		 }else if(result.error==-3){
                            			 return AA.User.warning(tip ,'真实姓名与认证不符');
                            		 }else if(result.error==-4){
                            			 return AA.User.warning(tip ,'身份证号与认证不符');
                            		 }else if(result.error==1009){
                            			 AA.RapidLogin.popup();
                            		 }
                            	 }
                             }
                         });
                	}
                },

                //银行卡修改短信倒计时
                modifyBankcardCountDown:function(count){

                	 var el = $('#btn-send-code');
                     AA.Helper.disabled(el ,'white').val('重发(' + count + ')');
                	 el.html('重发(' + count + ')');
                     if (g_timer) {
                         clearTimeout(g_timer);
                     }
                     if (--count >= 0) {
                         g_timer = setTimeout('AA.User.Setting.AuthInfo.modifyBankcardCountDown(' + count + ')' ,1000);
                     } else {

                         AA.Helper.enabled(el ,'white').val('重发');
                         el.html('重发');
                     }
                },

                /**
                 * 更新步骤
                 * @param index 当前步骤索引
                 */
                updateStep:function (index) {
                    $('.ui-step-label').removeClass('ui-step-current');
                    $('.ui-step-' + index + ' .ui-step-label').addClass('ui-step-current');
                } ,
                /**
                 * 发送短信验证码倒计时
                 * @param count
                 */
                countDown:function (count) {
                	is_sendSms=true;
                    var el = $('#btn-code-again');
                    AA.Helper.disabled(el ,'white').val('重发(' + count + ')');
                    if (g_timer) {
                        clearTimeout(g_timer);
                    }
                    if (--count >= 0) {
                        g_timer = setTimeout('AA.User.Setting.AuthInfo.countDown(' + count + ')' ,1000);
                    } else {
                        AA.Helper.enabled(el ,'white').val('重发');
                    }
                } ,
                /**
                 * 认证信息表单验证
                 */
                validate:function (o) {
                    var _el = $(o),
                        _val = $.trim(_el.val()),
                        _tip = _el.nextAll('em'),
                        _label ,
                        _warning = AA.User.warning,
                        _success = AA.User.success,
                        _result = '';

                    if (_val == '') {
                        var _action_label = o.nodeName.toUpperCase() == 'SELECT' ? '选择' : '填写';
                        _label = (o.id == 'province' || o.id == 'city' || o.id == 'district') ? $('option:selected' ,_el).html() : ('请' + _action_label + _el.prev('label').html().replace('：' ,''));
                        return _warning(_tip ,_label);
                    } else {
                        if (o.id.indexOf('email') != -1 && !AA.Validator.checkEmail(_val)) {
                            return _warning(_tip ,'邮箱格式不正确');
                        }

                        if (o.id.indexOf('mobile') != -1 && !AA.Validator.checkMobile(_val)) {
                            return _warning(_tip ,'手机格式不正确');
                        }

                        if (o.id == 'new-email') {
                            if (G_ENV_VAR.IS_CHECKED_EMAIL) {
                                if (_val == $('#now-email-label').html()) {
                                    return _warning(_tip ,'不能跟当前邮箱地址相同');
                                }
                            }
                        }

                        if (o.id == 'realname' && (!isNaN(_val.charAt(0)) || AA.Helper.getLength(_val) < 4)) {
                            return _warning(_tip ,'真实姓名格式不正确');
                        }

                        if (o.id == 'number') {
                            _result = AA.Validator.checkIDCard(_val);
                            if (_result != '1') {
                                return _warning(_tip ,_result);
                            }
                        }

                        if (o.id.indexOf('bankcard') != -1) {
                            _val = _val.replace(/\s/g ,'');
                            _result = AA.Validator.checkBankCard(_val);

                            if (o.id == 'confirm_bankcard' && _val != $.trim($('#bankcard').val().replace(/\s/g ,''))) {
                                return _warning(_tip ,'两次输入银行卡号不一致');
                            }

                            if (!_result) {
                                return _warning(_tip ,AA.Helper.buildError(2024));
                            }
                        }

                        if (o.id == 'code' && !/^\d{6}$/.test(_val)) {
                            return _warning(_tip ,'验证码必须为6位数字');
                        }

                        return _success(_tip);
                    }

                } ,
                /**
                 * 发送邮件倒计时
                 */
                emailCountDown:function (count) {
                    var btn = $('#btn-try-again'), label = $('#countdown');
                    AA.Helper.disabled(btn ,'white')
                    label.html(count + '');
                    if (g_timer) {
                        clearTimeout(g_timer);
                    }
                    if (--count >= 0) {
                        setTimeout('AA.User.Setting.AuthInfo.emailCountDown(' + count + ')' ,1000);
                    } else {
                        label.html(0 + '');
                        AA.Helper.enabled(btn ,'white');
                    }
                } ,
                /**
                 * 支付提示
                 * @param fn
                 */
                payTip:function (fn ,title ,content ,txtBtn ,tipCls ,padding) {
                    var _title = '',
                        _txtBtn = txtBtn || '继　续',
                        _content = content || '',
                        _tipCls = tipCls || 'info',
                        _padding = padding || 'margin:25px 0 0 80px;';
                    $.dialog({
                        title:_title ,
                        content:'<div style="width: 480px;height:120px;text-align: center">' +
                            '<p class="ui-tip ' + _tipCls + '" style="' + _padding + ';text-align: left;font-weight: 700">' + _content + '</p>' +
                            '<a class="ui-button ui-button-orange" style="margin-top: 40px;" id="btn-go-pay">' + _txtBtn + '</a>' +
                            '</div>' ,
                        initialize:function () {
                            var _dialog = this;
                            $('#btn-go-pay').click(function () {
                                _dialog.close();
                                fn && fn();
                            });
                        }
                    })
                } ,
                /**
                 * 实名认证扣费
                 */
                identityPay:function () {
                    var _identity_pay_dialog_html = $('#wgt-dialog-identity-pay-wrapper').html(),
                        _title = '实名认证';
                    $.dialog({
                        title:_title ,
                        content:_identity_pay_dialog_html ,
                        initialize:function () {
                            var _available_total_money = $('#available-total-money').val(),
                                _identity_check_fee = $('#identity-check-fee').val(),
                                _lackBanlance = parseFloat(_available_total_money) < parseFloat(_identity_check_fee),
                                _pay_form = $('#identity-pay-form'),
                                _confirm_form = _pay_form.find('.pay-confirm-form'),
                                _pay_dialog = this,
                                _btn_pay = _confirm_form.find('.ui-button[type="submit"]');

                            _pay_form.find('.money').html(_identity_check_fee);
                            _confirm_form.find('.wgt-dialog-title').html(_title + '手续费').css({'padding-left':'80px'});
                            _confirm_form.find('.ui-form-action');
                            _confirm_form.find('.money').html(_identity_check_fee);
                            _btn_pay.val('确 定');

                            AA.doPay({
                                lackBalance:_lackBanlance ,
                                callback:function (_val) {
                                    AA.Api.Auth.Identity.charge({
                                        password:_val
                                    } ,function (result) {
                                        if (result.state == 1) {
                                            _pay_dialog.close();
                                            AA.User.Setting.AuthInfo.payTip(AA.User.Setting.AuthInfo.authIDentity ,_title ,_title + '手续费支付成功!' ,'继续认证' ,'success1' ,'margin:25px 0 0 135px');
                                        } else {
                                            AA.User.warning($('#safepass').nextAll('.ui-tip') ,AA.Helper.buildError(result.error));
                                            AA.Helper.enabled(_btn_pay);
                                            _btn_pay.next('.ui-loading').hide();
                                        }
                                    });
                                }
                            });
                        }
                    });
                } ,
                /**
                 * 银行卡认证扣费
                 */
                bankCardPay:function () {
                    var _bankcard_pay_dialog_html = $('#wgt-dialog-bankcard-pay-wrapper').html(),
                        _title = '银行卡认证';
                    $.dialog({
                        title:_title ,
                        content:_bankcard_pay_dialog_html ,
                        initialize:function () {
                            var _available_total_money = $('#available-total-money').val(),
                                _bankcard_check_fee = $('#bankcard-check-fee').val(),
                                _lackBanlance = parseFloat(_available_total_money) < parseFloat(_bankcard_check_fee),
                                _pay_form = $('#bankcard-pay-form'),
                                _confirm_form = _pay_form.find('.pay-confirm-form'),
                                _pay_dialog = this,
                                _btn_pay = _confirm_form.find('.ui-button[type="submit"]');

                            _pay_form.find('.money').html(_bankcard_check_fee);
                            _confirm_form.find('.wgt-dialog-title').html(_title + '手续费').css({'padding-left':'15px'});
                            _confirm_form.find('.money').html(_bankcard_check_fee);
                            _btn_pay.val('确 定');

                            AA.doPay({
                                lackBalance:_lackBanlance ,
                                callback:function (_val) {
                                    AA.Api.Auth.BankCard.charge({
                                        password:_val
                                    } ,function (result) {
                                        if (result.state == 1) {
                                            _pay_dialog.close();
                                            AA.User.Setting.AuthInfo.payTip(AA.User.Setting.AuthInfo.authBankcard ,_title ,_title + '手续费支付成功!' ,'重新认证' ,'success1' ,'margin:25px 0 0 135px');
                                        } else {
                                            AA.User.warning($('#safepass').nextAll('.ui-tip') ,AA.Helper.buildError(result.error));
                                            AA.Helper.enabled(_btn_pay);
                                            _btn_pay.next('.ui-loading').hide();
                                        }
                                    });
                                }
                            });
                        }
                    });
                } ,
                /**
                 * 邮箱验证
                 */
                authEmail:function () {
                    var _title = '邮箱认证',
                        _dialog_html = $('#wgt-dialog-auth-email-wrapper').html();

                    $.dialog({
                        title:_title ,
                        content:_dialog_html ,
                        initialize:function () {
                            var $email = $('#new-email'),
                                _tip = $email.nextAll('.ui-tip'),
                                $pwd = $('#safepwd:visible'),
                                _pwd_tip = $pwd.nextAll('.ui-tip'),
                                _dialog = this,
                                _input,
                                _validate = AA.User.Setting.AuthInfo.validate,
                                _btn_submit = $('#email-form .ui-button[type="submit"]');

                            _input = $('#email-form:visible .ui-form-input');

                            _input.blur(function () {
                                if ($.trim($(this).val()) != '') {
                                    _validate(this);
                                }
                            }).eq(0).focus();

                            _btn_submit.click(function () {
                                _email = $.trim($email.val());
                                _pwd = $.trim($pwd.val());

                                _input.each(function () {
                                    if (!_validate(this)) {
                                        $(this).focus();
                                        return false;
                                    }
                                });

                                if (AA.User.isValid) {
                                    _btn_submit.next('.ui-loading').show();
                                    AA.Helper.disabled(_btn_submit);
                                    AA.Api.Auth.Email.checkInfo(
                                        $('#email-form').serialize() ,
                                        function (result) {
                                            if (result.state == 1) {
                                                $('.change-email-form,.fill-email').hide();
                                                $('.send-email').show();
                                                $('#new-email-label').html(_email);
                                                $('.check-email').attr('href' ,AA.Helper.buildEmailUrl(_email));

                                                //修改地址
                                                $('#btn-change-email').click(function () {
                                                    $('#is-refresh-page').val('0');
                                                    _dialog.close();
                                                    $('.auth-email .btn-email-auth').click();
                                                    $('.change-email-form,.fill-email').show();
                                                    $('.send-email').hide();
                                                    clearTimeout(g_timer);
                                                });

                                                AA.User.Setting.AuthInfo.emailCountDown(120);

                                                $('#btn-try-again').click(function () {
                                                    var _btn_try = $(this), _try_tip = _btn_try.nextAll('.ui-tip');
                                                    _try_tip.removeClass('ui-tip').addClass('ui-loading').html('发送中...').show();
                                                    AA.User.Setting.AuthInfo.emailCountDown(120);
                                                    AA.Api.Auth.Email.checkInfo(
                                                        $('#email-form').serialize() ,
                                                        function (result) {
                                                            _try_tip.removeClass('ui-loading').addClass('ui-tip');
                                                            if (result.state == 1) {
                                                                AA.User.success(_try_tip ,'发送成功');
                                                            } else {
                                                                if (result.error == 1009) {
                                                                    _dialog.close();
                                                                    AA.RapidLogin.popup();
                                                                }
                                                                AA.User.warning(_try_tip ,'发送失败');
                                                            }
                                                            _try_tip.fadeOut(5000);
                                                        });
                                                });
                                            } else {
                                                if (result.error == 1009) {
                                                    _dialog.close();
                                                    AA.RapidLogin.popup();
                                                } else if (result.error == 2008 || result.error == 2009) {
                                                    AA.User.warning(_pwd_tip ,AA.Helper.buildError(result.error));
                                                } else {
                                                    AA.User.warning(_tip ,AA.Helper.buildError(result.error));
                                                }
                                            }
                                            _btn_submit.next('.ui-loading').hide();
                                            AA.Helper.enabled(_btn_submit);
                                            $('#is-refresh-page').val('1');
                                        }
                                    )
                                }
                                return false;
                            });
                        } ,
                        beforeunload:function () {
                            if ($('#is-refresh-page').val() == '1') {
                                location.reload(true);
                            }
                        }
                    });
                } ,
                /**
                 * 手机认证
                 */
                authMobile:function () {
                    var _title = $('.auth-mobile .success').length == 1 ? '修改手机号码' : '手机认证',
                        _auth_mobile_dialog_html = $('#wgt-dialog-auth-mobile-wrapper').html();

                    $.dialog({
                        title:_title ,
                        content:_auth_mobile_dialog_html ,
                        initialize:function () {
                            var $mobile = $("#mobileNo"),
                                $pwd = $("#pwd"),
                                _dialog = this,
                                _form = $('#mobile-form'),
                                _btn_submit = _form.find('.ui-button[type="submit"]'),
                                _btn_voice_button=_form.find('.ui-button[type="button"]'),
                                _validate = AA.User.Setting.AuthInfo.validate;

                            _input = _form.find('.ui-form-input:visible');

                            var captcha=$('#rapid-captcha');
                            AA.Api.User.captcha({t:4} ,function (result) {
                                var _ph = $('#rapid-captcha-placeholder'), _seed = $('#rapid-seed');

                                _ph.html(result.data.image);
                                _seed.val(result.data.seed);
                                _ph.click(function () {
                                    AA.Api.User.captcha({t:4} ,function (result) {
                                        _ph.html(result.data.image);
                                        _seed.val(result.data.seed);
                                    });
                                    return false;
                                });
                            });

                            _input.blur(function () {
                                if ($.trim($(this).val()) != '') {
                                    _validate(this);
                                }
                            }).eq(0).focus();

                            _btn_voice_button.click(function(){

	                            	 var _mobile = $.trim($mobile.val()),
	                                 _tip = $('#error_tip');

	                             _input.each(function () {
	                                 if (!_validate(this)) {
	                                     $(this).focus();
	                                     return false;
	                                 }
	                             });


	                             if(_title!='修改手机号码'){

	                             	 var _cVal=$("#rapid-captcha").val();

	                                  if(_cVal==""){
	                               	   _tip.addClass('error').html('请填写验证码');
	                               	  $("#rapid-captcha").focus();
	                                      return false;
	                                  }else if(_cVal.length !=4){
	                               	   _tip.addClass('error').html('验证码必须为4个字符');
	                               	  $("#rapid-captcha").focus();
	                                      return false;
	                                  }
	                             }




	                             if (AA.User.isValid) {

	                            	 send_voice_code();
	                             }
                            });

                            _btn_submit.click(function () {
                                var _mobile = $.trim($mobile.val()),
                                    _tip = $('#error_tip');

                                _input.each(function () {
                                    if (!_validate(this)) {
                                        $(this).focus();
                                        return false;
                                    }
                                });


                                if(_title!='修改手机号码'){

                                	 var _cVal=$("#rapid-captcha").val();

                                     if(_cVal==""){
                                  	   _tip.addClass('error').html('请填写验证码');
                                  	  $("#rapid-captcha").focus();
                                         return false;
                                     }else if(_cVal.length !=4){
                                  	   _tip.addClass('error').html('验证码必须为4个字符');
                                  	  $("#rapid-captcha").focus();
                                         return false;
                                     }
                                }




                                if (AA.User.isValid) {
                                    $('.ui-loading').show();
                                    AA.Helper.disabled(_btn_submit);
                                    AA.Helper.disabled(_btn_voice_button);
                                    AA.Api.Auth.Mobile.checkInfo(
                                        _form.serialize() ,
                                        function (result) {
                                            if (result.state == 1) {
                                                var $code = $("#code"),
                                                    _btn_again = $('#btn-code-again'),
                                                    count = 120,
                                                    _code_tip = $code.next('.ui-tip');

                                                $('.mobile-send-code').hide();
                                                $('.mobile-validate-code').show();
                                                $code.focus();
                                                //倒计时
                                                AA.User.Setting.AuthInfo.countDown(count);
                                                _btn_again.click(function () {
                                                	//t_code:短信模板
                                                	//is_reSendSms=true;
                                                	//AA.User.Setting.AuthInfo.send_code_check(1,_mobile);

                                                	AA.Api.Auth.Mobile.checkInfo({mobile:$mobile.val()},function(rs){

                                                	});
                                                    AA.User.Setting.AuthInfo.countDown(count);
                                                });

                                                $('.mobileno').html(_mobile);
                                                var btn_submit = $('#btn-code-submit');
                                                AA.Helper.enabled(btn_submit);
                                                btn_submit.click(function () {
                                                    _code = $.trim($code.val());

                                                    _input = $('#mobile-form:visible .ui-form-input');
                                                    _input.each(function () {
                                                        if (!_validate(this)) {
                                                            $(this).focus();
                                                            return false;
                                                        }
                                                    });

                                                    //验证码
                                                    if (AA.User.isValid) {
                                                        AA.Helper.disabled(btn_submit);

                                                        AA.Api.Auth.Mobile.validate(
                                                            {code:_code} ,
                                                            function (result) {
                                                                if (result.state == 1) {
                                                                    $('.mobile-validate-code').hide();
                                                                    $('.mobile-finish').show();
                                                                } else {
                                                                    if (result.error == 1009) {
                                                                        AA.RapidLogin.popup();
                                                                    }
                                                                    AA.User.warning(_code_tip ,AA.Helper.buildError(result.error));
                                                                    AA.Helper.enabled(btn_submit);
                                                                }
                                                            }
                                                        );
                                                    }
                                                });
                                            } else {

                                                if (result.error == 1009) {
                                                    _dialog.close();
                                                    AA.RapidLogin.popup();
                                                } else if (result.error == 2008) {

                                                    AA.User.warning(_tip ,AA.Helper.buildError(result.error));
                                                    $pwd.val('');
                                                } else if (result.error == 2010) {
                                                    AA.User.warning(_tip ,'验证码错误');
                                                    AA.Api.User.captcha({t:4} ,function (result) {
                                                        var _ph = $('#rapid-captcha-placeholder'), _seed = $('#rapid-seed');

                                                        _ph.html(result.data.image);
                                                        _seed.val(result.data.seed);
                                                        _ph.click(function () {
                                                            AA.Api.User.captcha({t:4} ,function (result) {
                                                                _ph.html(result.data.image);
                                                                _seed.val(result.data.seed);
                                                            });
                                                            return false;
                                                        });
                                                    });
                                                    $pwd.val('');
                                                }else if (result.error == 2012) {
                                                    AA.User.warning(_tip ,'该手机号码已被占用');
                                                    AA.Api.User.captcha({t:4} ,function (result) {
                                                        var _ph = $('#rapid-captcha-placeholder'), _seed = $('#rapid-seed');

                                                        _ph.html(result.data.image);
                                                        _seed.val(result.data.seed);
                                                        _ph.click(function () {
                                                            AA.Api.User.captcha({t:4} ,function (result) {
                                                                _ph.html(result.data.image);
                                                                _seed.val(result.data.seed);
                                                            });
                                                            return false;
                                                        });
                                                    });
                                                    $pwd.val('');
                                                }else {
                                                    AA.User.warning(_tip ,AA.Helper.buildError(result.error));
                                                    //$mobile.val('');
                                                }
                                            }
                                            $('.ui-loading').hide();
                                            AA.Helper.enabled(_btn_submit);
                                            $('#is-refresh-page').val('1');
                                        }
                                    );
                                }
                                return false;
                            });
                        } ,
                        beforeunload:function () {
                            if ($('#is-refresh-page').val() == '1') {
                                location.reload(true);
                            }
                        }
                    });
                } ,
                /**
                 * 实名认证
                 */
                authIDentity:function () {
                    var _title = '实名认证';
                    var _dialog_html = $('#wgt-dialog-auth-identity-wrapper').html();
                    $.dialog({
                        title:_title ,
                        content:_dialog_html ,
                        initialize:function () {
                            var $realname = $("#realname"),
                                _name_tip = $realname.nextAll('.ui-tip'),
                                $number = $("#number"),
                                _number_tip = $number.nextAll('.ui-tip'),
                                _dialog = this,
                                _form = $('#identity-form'),
                                _validate = AA.User.Setting.AuthInfo.validate,
                                _btn_submit = $('.identity-form-fill .ui-button[type="submit"]'),
                                _tip = _btn_submit.nextAll('.ui-tip'),
                                _free_number = parseInt($('#identity-free-number').val()), //可免费认证次数
                                _auth_number = parseInt($('#identity-auth-number').val()), //已认证次数
                                _left_number = parseInt($('#identity-left-number').val()), //剩余次数
                                _auth_fee = $('#identity-check-fee').val();//认证费用

                            _input = _form.find('.ui-form-input:visible');

                            _input.blur(function () {
                                if ($.trim($(this).val()) != '') {
                                    _validate(this);
                                }
                            }).eq(0).focus();

                            _btn_submit.next('.ui-loading').hide();
                            AA.Helper.enabled(_btn_submit);

                            _btn_submit.click(function () {
                                _realname = $.trim($realname.val());
                                _number = $.trim($number.val());
                                _tip.hide();
                                _input.each(function () {
                                    if (!_validate(this)) {
                                        $(this).focus();
                                        return false;
                                    }
                                });

                                if (AA.User.isValid) {
                                    _btn_submit.next('.ui-loading').show();
                                    AA.Helper.disabled(_btn_submit);
                                    AA.Api.Auth.Identity.checkInfo(
                                        _form.serialize() ,
                                        function (result) {
                                            _btn_submit.next('.ui-loading').hide();
                                            AA.Helper.enabled(_btn_submit);
                                            $('#is-refresh-page').val('1');

                                            if (result.state == 1) {
                                                $('.identity-form-fill').hide();
                                                $('.identity-finish').show();
                                                $('#hidden-realname').val(_realname);
                                                $('#hidden-idcard').val(_number);
                                            } else {
                                                if (result.error == 1009) {
                                                    $('#is-refresh-page').val('0');
                                                    _dialog.close();
                                                    AA.RapidLogin.popup();
                                                } else if (result.error == 2074) {//实名认证异常
                                                    $('#is-refresh-page').val('0');
                                                    _dialog.close();

                                                    $.alert({
                                                        tipCls:'error1' ,
                                                        title:'实名认证系统暂不可用，请您稍后再试。' ,
                                                        txtBtn:'确 定' ,
                                                        url:'my/authinfo'
                                                    });
                                                } else if (result.error == 2034) {//实名认证失败
                                                    _auth_number = parseInt(result.data.check_number), _left_number = result.data.left_number;

                                                    $('.identity-form-fill').hide();

                                                    //认证次数超过3次进行扣费确认
                                                    if (_auth_number > _free_number || _left_number == 0) {
                                                        $('.identity-error .wgt-dialog-title').html('实名认证失败');
                                                        $('.identity-error .identity-error-tip').html('您已连续 ' + _auth_number + ' 次输入错误信息，重新认证将收取 ' + _auth_fee + ' 元手续费。');
                                                        //身份证认证失败次数过多

                                                        $('.identity-error').show().find('.ui-button').html('确 定').click(function () {
                                                            $('#is-refresh-page').val('0');
                                                            _dialog.close();
                                                            AA.User.Setting.AuthInfo.identityPay();
                                                        });
                                                        //.attr('href', AA.Helper.buildUrl('my/authinfo?_=' + (+new Date()) + '#identity'));
                                                    } else {
                                                        $('.identity-error .identity-error-tip').html('您还有 ' + _left_number + ' 次机会，超过 ' + _free_number + ' 次认证每次收取 ' + _auth_fee + ' 元手续费。');

                                                        $('.identity-error').show().find('.ui-button').click(function () {
                                                            $('.identity-form-fill').show();
                                                            $('.identity-error').hide();
                                                        });
                                                    }
                                                } else {
                                                    if (result.error == 2015 || result.error == 2018) {//身份证号码不合法或已被认证
                                                        _tip = _number_tip;
                                                    } else if (result.error == 2017) {
                                                        //用户已经认证过身份证
                                                        _tip = _btn_submit.next('.ui-tip');
                                                    } else if (result.error == 2016) {
                                                        _tip = _name_tip;
                                                    } else {
                                                        _tip = _btn_submit.nextAll('.ui-tip');
                                                    }
                                                    AA.User.warning(_tip ,AA.Helper.buildError(result.error));
                                                }
                                            }
                                        }
                                    )
                                }
                                return false;
                            });
                        } ,
                        beforeunload:function () {
                            if ($('#is-refresh-page').val() == '1') {
                                location.reload(true);
                            }
                        }
                    });


					//AA.User.Setting.AuthInfo.authIDentityBeifu();
                } ,
				authIDentityBeifu:function(){
					var _title = '实名认证';
                    var _dialog_html = $('#wgt-dialog-auth-identity-wrapper').html();
					 $.dialog({
                        title:_title ,
                        content:_dialog_html ,
                        initialize:function () {
							 var $realname = $("#realname"),
                                _name_tip = $realname.nextAll('.ui-tip'),
                                $number = $("#number"),
                                _number_tip = $number.nextAll('.ui-tip'),
                                _dialog = this,
                                _form = $('#identity-form'),
                                _validate = AA.User.Setting.AuthInfo.validate,
                                _btn_submit = $('.identity-form-fill .ui-button[type="submit"]'),
                                _tip = _btn_submit.nextAll('.ui-tip'),
                                _free_number = parseInt($('#identity-free-number').val()), //可免费认证次数
                                _auth_number = parseInt($('#identity-auth-number').val()), //已认证次数
                                _left_number = parseInt($('#identity-left-number').val()), //剩余次数
                                _auth_fee = $('#identity-check-fee').val();//认证费用


							_input = _form.find('.ui-form-input:visible');

                            _input.blur(function () {
                                if ($.trim($(this).val()) != '') {
                                    _validate(this);
                                }
                            }).eq(0).focus();

							 _btn_submit.next('.ui-loading').hide();
                            AA.Helper.enabled(_btn_submit);

							_btn_submit.click(function () {
                                _realname = $.trim($realname.val());
                                _number = $.trim($number.val());
                                _tip.hide();
                                _input.each(function () {
                                    if (!_validate(this)) {
                                        $(this).focus();
                                        return false;
                                    }
                                });

								if (AA.User.isValid) {
                                    _btn_submit.next('.ui-loading').show();
                                    AA.Helper.disabled(_btn_submit);

									 AA.Api.async({
										url:'/v2/authenticate/identity_auth.jso' ,
										type:'POST' ,
										data:{name:_realname,certNo:_number} ,
										success:function(data){

											 _btn_submit.next('.ui-loading').hide();
                                            AA.Helper.enabled(_btn_submit);
                                            $('#is-refresh-page').val('1');

											if(data.state == 0){
												 $('.identity-form-fill').hide();
                                                $('.identity-finish').show();
                                                $('#hidden-realname').val(_realname);
                                                $('#hidden-idcard').val(_number);
											}else if(data.state == 2001){
												 _tip = _number_tip;
												AA.User.warning(_tip ,'身份证格式不正确');
											}else if(data.state == 2003){
												/*$('.identity-error .wgt-dialog-title').html('实名认证失败');
                                                $('.identity-error .identity-error-tip').html(data.msg);
                                                        //身份证认证失败次数过多

												$('.identity-error').show().find('.ui-button').html('确 定').click(function () {
													$('#is-refresh-page').val('0');
													_dialog.close();
													AA.User.Setting.AuthInfo.identityPay();
												});*/

												 _tip = _number_tip;
												AA.User.warning(_tip ,data.msg);

											}else if(data.state == 2100||data.stat==2000){
												var leftTimes = data.msg;
												  $('.identity-error .identity-error-tip').html('您还有 ' + leftTimes + ' 次机会，超3次认证每次5元手续费。');

                                                        $('.identity-error').show().find('.ui-button').click(function () {
                                                            $('.identity-form-fill').show();
                                                            $('.identity-error').hide();
                                                        });
											}else{
												$('.identity-error .wgt-dialog-title').html("系统繁忙");
											}
										}
									 });
								}

							});
						}

					 });


				},
                /**
                 * 银行卡认证 - 提交银行卡信息
                 */
                authBankcard:function () {
                    var _title = '银行卡认证',
                        _auth_bankcard_dialog_html = $('#wgt-dialog-auth-bankcard-wrapper').html(),
                        _authinfo = AA.User.Setting.AuthInfo;

                    $('.fill-form').show();
                    $('.confirm-form').hide();

                    //1. 填写银行卡信息
                    _authinfo.updateStep(1);

                    $.dialog({
                        title:_title ,
                        padding:'0' ,
                        content:_auth_bankcard_dialog_html ,
                        initialize:function () {
                            var _dialog = this,
                                _form = $('#bankcard-form-1'),
                                _input = $('input:visible,select:visible' ,_form),
                                $bankcard = $('#bankcard'),
                                _validate = AA.User.Setting.AuthInfo.validate,
                                _btn_submit = $('#btn-bankinfo-submit'),
                                _tip = $('.action-state .ui-tip'),
                                _loading = $('.action-state .ui-loading');

                            $('#is-refresh-page').val('1');

                            $('.real-name-label').html($('#hidden-realname').val());
                            $('.id-number-label').html($('#hidden-idcard').val());

                            var for_yz=getUrlParam('p');

                    		if(for_yz=='yz'){

                    			$("<option value='中国邮政储蓄银行'>中国邮政储蓄银行</option>").appendTo("#bank");
                    		}


                            //初始化省市区
                            AA.Address.init();

                            _input.blur(function () {
                                if ($.trim($(this).val()) != '') {
                                    _validate(this);
                                }
                                //格式化银行卡号
                                if (this.id.indexOf('bankcard') != -1) {
                                    this.value = AA.Helper.formatBankCard(this.value);
                                }
                            }).focus(function () {
                                    //银行卡号去空格
                                    if (this.id.indexOf('bankcard') != -1) {
                                        this.value = this.value.replace(/\s/g ,'');
                                    }
                                }).eq(0).focus();

                            $('.fill-form .ui-button[type="submit"]').click(function () {
                                _input = $('input:visible,select:visible' ,_form);

                                _input.each(function () {
                                    if (!_validate(this)) {
                                        return false;
                                    }
                                });

                                if (AA.User.isValid) {
                                    //2. 确认并提交
                                    _authinfo.updateStep(2);

                                    if ($('#safe-password').length == 1) {
                                        $('#safe-password').next('em').html('').removeClass('error');
                                    }
                                    _tip.hide();
                                    //显示确认信息
                                    $('.fill-form').hide();
                                    $('.confirm-form,.wgt-dialog-title').show();

                                    $('.bank').html($('#bank option:selected').text());
                                    $('.location').html($('#province option:selected').text() + '，' + $('#city option:selected').text() + '，' + $('#district option:selected').text());
                                    $('.subbranch').html($('#sub_branch').val());
                                    $('.number').html($('#bankcard').val());
                                    $('#bank-real-name').css({'margin-left':'78px'});


                                    _loading.hide();
                                    AA.Helper.enabled(_btn_submit);

                                    $('#btn-bankinfo-edit:visible').click(function () {
                                        _authinfo.updateStep(1);
                                        $('.fill-form').show();
                                        $('.confirm-form,.wgt-dialog-title').hide();
                                        $('#bank-real-name').css({'margin-left':'0'});
                                    });

                                    _btn_submit.unbind('click').click(function () {
                                        var _pwd = $('#safe-password');

                                        if (_pwd.length == 1) {
                                            if (_pwd.val() == '') {
                                                AA.User.warning(_tip ,'请填写交易密码');
                                                _pwd.focus();
                                                return false;
                                            } else {
                                                AA.User.success(_tip);
                                            }
                                        }
                                        $('#number-hidden').val($bankcard.val().replace(/\s/g ,''));

                                        _loading.show();
                                        AA.Helper.disabled(_btn_submit);

                                        AA.Api.Auth.BankCard.checkInfo(
                                            _form.serialize() ,
                                            function (result) {
                                                _loading.hide();
                                                AA.Helper.enabled(_btn_submit);
                                                if (result.state == 1) {
                                                    _dialog.close();

                                                    $.alert({
                                                        tipCls:'success1' ,
                                                        title:'您的银行卡认证申请已提交。' ,
                                                        content:'请在银行卡收到认证打款金额后进行金额确认。' ,
                                                        txtBtn:'确 定' ,
                                                        url:'my/authinfo' ,
                                                        refresh:true
                                                    });
                                                } else if (result.error == 1009) {
                                                    _dialog.close();
                                                    AA.RapidLogin.popup();
                                                }else if(result.error == 2070){

                                                	 AA.User.warning(_tip ,'用户已有绑定的代扣/认证支付银行卡，不允许修改');
                                                }else {
                                                    _pwd.focus();
                                                    AA.User.warning(_tip ,AA.Helper.buildError(result.error));
                                                }
                                            });
                                        return false;
                                    });
                                }
                                return false;
                            });
                        }
                    });
                } ,
                authBankcardBack:function(){
                	$('#img_step').attr('src','/s/img/bank_modify_step2.png');
                      $('#fill-modify-form').show();
                      $('#bank-modify-confirm-form').hide();
                },
                authBankcardModify1:function(){

                	var _authinfo = AA.User.Setting.AuthInfo;

                	$('#show_f_form').hide();
            		$('#fill-modify-form').show();

            		$('#img_step').attr('src','/s/img/bank_modify_step2.png');

            		var for_yz=getUrlParam('p');

            		if(for_yz=='yz'){

            			$("<option value='中国邮政储蓄银行'>中国邮政储蓄银行</option>").appendTo("#bank");
            		}


            		 var _form = $('#bankcard-form-modify'),
                     _input = $('input:visible,select:visible' ,_form),
                     $bankcard = $('#bankcard'),
                     _validate = AA.User.Setting.AuthInfo.validate,
                     _btn_submit = $('#btn-bankinfo-submit'),
                     _tip = $('.action-state .ui-tip'),
                     _loading = $('.action-state .ui-loading');

	                 $('#is-refresh-page').val('1');

	                 $('.real-name-label').html($('#hidden-realname').val());
	                 $('.id-number-label').html($('#hidden-idcard').val());

	                 //初始化省市区
	                 AA.Address.init();

	                 _input.blur(function () {
	                     if ($.trim($(this).val()) != '') {
	                         _validate(this);
	                     }
	                     //格式化银行卡号
	                     if (this.id.indexOf('bankcard') != -1) {
	                         this.value = AA.Helper.formatBankCard(this.value);
	                     }
	                 }).focus(function () {
	                         //银行卡号去空格
	                         if (this.id.indexOf('bankcard') != -1) {
	                             this.value = this.value.replace(/\s/g ,'');
	                         }
	                     }).eq(0).focus();


	                 $('#fill-modify-form .ui-button[type="submit"]').click(function () {

	                	  _input = $('input:visible,select:visible' ,_form);

                          _input.each(function () {
                              if (!_validate(this)) {
                            	  return false;
                              }
                          });

                          if (AA.User.isValid) {

                        	  $('#img_step').attr('src','/s/img/bank_modify_step3.png');

                        	  if ($('#safe-password').length == 1) {
                                  $('#safe-password').next('em').html('').removeClass('error');
                              }
                              _tip.hide();
                              //显示确认信息
                              $('#fill-modify-form').hide();
                              $('#bank-modify-confirm-form').show();

                              $('.bank').html($('#bank option:selected').text());
                              $('.location').html($('#province option:selected').text() + '，' + $('#city option:selected').text() + '，' + $('#district option:selected').text());
                              $('.subbranch').html($('#sub_branch').val());
                              $('.number').html($('#bankcard').val());
                              $('#bank-real-name').css({'margin-left':'78px'});


                              _loading.hide();
                              AA.Helper.enabled(_btn_submit);



                              $('#btn-bankinfo-submit1').click(function () {

	                            	  var _pwd = $('#safe-password-1');

	                                  if (_pwd.length == 1) {
	                                      if (_pwd.val() == '') {
	                                          AA.User.warning(_tip ,'请填写交易密码');
	                                          _pwd.focus();
	                                          return false;
	                                      } else {
	                                          AA.User.success(_tip);
	                                      }
	                                  }
	                                  $('#number-hidden').val($bankcard.val().replace(/\s/g ,''));

	                                  _loading.show();
	                                  AA.Helper.disabled(_btn_submit);

	                                  AA.Api.Auth.BankCard.checkInfo(
	                                            _form.serialize() ,
	                                            function (result) {
	                                                _loading.hide();
	                                                AA.Helper.enabled(_btn_submit);
	                                                if (result.state == 1) {
	                                                	AA.User.bankcard_modify_dialog.close();

	                                                    $.alert({
	                                                        tipCls:'success1' ,
	                                                        title:'您的银行卡认证申请已提交。' ,
	                                                        content:'请在银行卡收到认证打款金额后进行金额确认。' ,
	                                                        txtBtn:'确 定' ,
	                                                        url:'my/authinfo' ,
	                                                        refresh:true
	                                                    });
	                                                } else if (result.error == 1009) {
	                                                	AA.User.bankcard_modify_dialog.close();
	                                                    AA.RapidLogin.popup();
	                                                } else if(result.error == 2070){

	                                                	 AA.User.warning(_tip ,'用户已有绑定的代扣/认证支付银行卡，不允许修改');
	                                                }else {
	                                                    _pwd.focus();
	                                                    AA.User.warning(_tip ,AA.Helper.buildError(result.error));
	                                                }
	                                  });

	                                 return false;
                              });

                          }

                          return false;
	                 });

                },
                /**
                 * 银行卡认证 - 验证认证金额
                 */
                authBankcard1:function () {
                    var _auth_bankcard1_dialog_html = $('#wgt-dialog-auth-bankcard1-wrapper').html(),
                        _authinfo = AA.User.Setting.AuthInfo,
                        _title = "银行卡认证";

                    $.dialog({
                        title:_title ,
                        content:_auth_bankcard1_dialog_html ,
                        initialize:function () {
                            var _dialog = this,
                                $money = $('#transfer-money'),
                                _btn_submit = $('.bank-auth-fill-money .ui-button[type="submit"]');
                            //3. 填写打入卡内金额
                            _authinfo.updateStep(3);

                            $money.focus();
                            //提交认证

                            $('.ui-loading').hide();
                            AA.Helper.enabled(_btn_submit);

                            _btn_submit.click(function () {
                                var _money = $.trim($money.val()),
                                    _tip = $money.nextAll('p.ui-tip');

                                if (_money == '') {
                                    AA.User.warning(_tip ,'请填写您卡内实际收到的金额');
                                    $money.focus();
                                    return false;
                                }

                                if (!/^\d+(\.\d+)?$/.test(_money)) {
                                    AA.User.warning(_tip ,'金额格式不正确');
                                    $money.focus();
                                    return false;
                                }

                                $('.ui-loading').show();
                                AA.Helper.disabled(_btn_submit);
                                AA.Api.Auth.BankCard.checkMoney(
                                    {money:_money} ,
                                    function (result) {
                                        if (result.state == 1) {
                                            //4. 认证成功
                                            _authinfo.updateStep(4);
                                            $('.bank-auth-fill-money').hide();
                                            $('.bankcard-tail').html($('#label-bank-card-tail').html().replace(/\*/g ,''));//尾号
                                            $('.bank-auth-finish').show();
                                        } else {
                                            var _error_msg = '';
                                            if (result.error == 1009) {
                                                _dialog.close();
                                                AA.RapidLogin.popup();
                                            } else if (result.error == 2031) {
                                                _error_msg = '打款未成功，请收到打款金额后再认证';
                                            } else {
                                                if (result.data.left_number == 0) {
                                                    //4. 认证失败
                                                    //_authinfo.updateStep(4);
                                                    $('.bank-auth-fill-money').hide();
                                                    $('.bank-auth-finish').show();
                                                    $('#finish-title').removeClass('success1').addClass('error1').html('银行卡认证失败！');
                                                    $('#finish-tip').html('您已连续 3 次输入错误的打入金额，本次认证失败。 <a href="' + AA.Helper.buildUrl('my/authinfo?_=' + (+new Date()) + '#bankcard') + '" class="blue" id="cardbank-reauth"> 重新发起认证</a>');
                                                    $('.u-can-go').hide();
                                                } else {
                                                    $money.focus();
                                                    _error_msg = '金额不正确，请更正后再提交（还剩 <strong>' + result.data.left_number + '</strong> 次机会）';
                                                }
                                            }
                                            AA.User.warning(_tip ,_error_msg);
                                        }
                                        $('.ui-loading').hide();
                                        AA.Helper.enabled(_btn_submit);
                                        $('#is-refresh-page').val('1');
                                    });
                                return false;
                            });
                        } ,
                        beforeunload:function () {
                            if ($('#is-refresh-page').val() == '1') {
                                location.reload(true);
                            }
                        }
                    });
                },
                authBankcardUpdate:function () {

              	  var _auth_bankcard1_dialog_html = $('#wgt-dialog-auth-bankcard-update-wrapper').html(),
                    _authinfo = AA.User.Setting.AuthInfo,
                    _title = "银行账户修改";

              	  $.dialog({
              		  title:_title ,
                        content:_auth_bankcard1_dialog_html ,
                        padding:'20px 5px 5px 5px',
                        initialize:function () {AA.User.bankcard_modify_dialog=this},
                        beforeunload:function () {
                            if ($('#is-refresh-page').val() == '1') {
                                location.reload(true);
                            }
                        }
              	  });

              }
            } ,

            /**
             * 密码管理
             */
            Password:{
                init:function () {
                    if (!AA.Api.User.isAuth) {
                        AA.RapidLogin.popup();
                    }
                    $('#change-login-pwd').click(function () {
                            var _dialog_html = $('#wgt-dialog-change-login-pwd-wrapper').html(),
                                _pwd = AA.User.Setting.Password;

                            $.dialog({
                                    title:'修改登录密码' ,
                                    content:_dialog_html ,
                                    initialize:function () {
                                        var _input = $('#change-login-pwd-form .ui-form-input:visible'),
                                            _dialog = this;

                                        _input.blur(function () {
                                            if ($.trim($(this).val()) != '') {
                                                _pwd.validate(this);
                                            }
                                        }).eq(0).focus();

                                        $('#change-login-pwd-form .ui-button').click(function () {
                                            var _btn = $(this);

                                            _input.each(function () {
                                                if (!_pwd.validate(this)) {
                                                    $(this).focus();
                                                    return false;
                                                }
                                            });

                                            if (AA.User.isValid) {
                                                AA.Api.User.changeLoginPwd(
                                                    $('#change-login-pwd-form:visible').serialize() ,
                                                    function (result) {
                                                        var _new_tip = $('#new-login-pass').nextAll('.ui-tip'), _now_tip = $('#now-login-pass').nextAll('.ui-tip');
                                                        if (result.state == 1) {
                                                            _dialog.close();
                                                            $.alert({
                                                                tipCls:'success1' ,
                                                                title:'登录密码修改成功!' ,
                                                                content:'为了您的安全，请妥善保管您的密码。' ,
                                                                txtBtn:'确 定' ,
                                                                url:'logout' ,
                                                                refresh:true
                                                            });
                                                        }
                                                        else if (result.error == 1009) {
                                                            _dialog.close();
                                                            AA.RapidLogin.popup();
                                                        } else if (result.error == 2038) {
                                                            AA.User.warning(_now_tip ,AA.Helper.buildError('2038'));
                                                        } else {
                                                            AA.User.warning(_new_tip ,AA.Helper.buildError(result.error));
                                                        }
                                                    }
                                                    ,
                                                    function () {
                                                        AA.User.warning(_btn.next('em') ,AA.Helper.buildError(result.error));
                                                    }

                                                )
                                            }
                                            return false;
                                        });
                                    }
                                }
                            )
                            ;
                        }
                    )
                    ;
                    $('#set-safe-pwd').click(function () {
                        var _dialog_html = $('#wgt-dialog-set-safe-pwd-wrapper').html(),
                            _pwd = AA.User.Setting.Password;
                        //如果未认证邮箱跟手机

                        if (!G_ENV_VAR.IS_CHECKED_EMAIL) {
                            $.alert({
                                title:'您的邮箱尚未经过验证！' ,
                                content:'<span class="orange">友情提示：</span>完成邮箱验证后才可以设置交易密码。' ,
                                txtBtn:'立即验证' ,
                                url:'my/authinfo#email'
                            });
                        }
                        else if (!G_ENV_VAR.IS_CHECKED_MOBILE) {
                            $.alert({
                                title:'您的手机号尚未经过认证！' ,
                                content:'<span class="orange">友情提示：</span>完成手机号认证后才可以设置交易密码' ,
                                txtBtn:'立即认证' ,
                                url:'my/authinfo#mobile'
                            });
                        } else {
                            $.dialog({
                                title:'设置交易密码' ,
                                content:_dialog_html ,
                                initialize:function () {
                                    var _input = $('#set-safe-pwd-form .ui-form-input:visible'),
                                        _dialog = this;

                                    _input.blur(function () {
                                        if ($.trim($(this).val()) != '') {
                                            _pwd.validate(this);
                                        }
                                    }).eq(0).focus();

                                    $('#set-safe-pwd-form .ui-button').click(function () {
                                        var _btn = $(this);

                                        _input.each(function () {
                                            if (!_pwd.validate(this)) {
                                                $(this).focus();
                                                return false;
                                            }
                                        });

                                        if (AA.User.isValid) {
                                            AA.Api.User.changeSafePwd(
                                                $('#set-safe-pwd-form:visible').serialize() ,
                                                function (result) {
                                                    if (result.state == 1) {
                                                        _dialog.close();
                                                        $.alert({
                                                            tipCls:'success1' ,
                                                            title:'交易密码设置成功!' ,
                                                            content:'为了您的安全，请妥善保管您的密码。' ,
                                                            txtBtn:'确 定' ,
                                                            url:'my/password' ,
                                                            refresh:true
                                                        });
                                                    }
                                                    else {
                                                        if (result.error == 1009) {
                                                            AA.RapidLogin.popup();
                                                        }
                                                        AA.User.warning($('#safe-pass').nextAll('.ui-tip') ,AA.Helper.buildError(result.error));
                                                    }
                                                }
                                                ,
                                                function () {
                                                    AA.User.warning(_btn.next('em') ,AA.Helper.buildError(result.error));
                                                }

                                            )
                                        }
                                        return false;
                                    });
                                }
                            })
                            ;
                        }
                    })
                    ;
                    $('#change-safe-pwd').click(function () {
                        var _dialog_html = $('#wgt-dialog-change-safe-pwd-wrapper').html(),
                            _pwd = AA.User.Setting.Password;

                        $.dialog({
                            title:'修改交易密码' ,
                            content:_dialog_html ,
                            initialize:function () {
                                var _input = $('#change-safe-pwd-form .ui-form-input:visible'),
                                    _dialog = this;

                                _input.blur(function () {
                                    if ($.trim($(this).val()) != '') {
                                        _pwd.validate(this);
                                    }
                                }).eq(0).focus();

                                $('#change-safe-pwd-form .ui-button').click(function () {
                                    var _btn = $(this);

                                    _input.each(function () {
                                        if (!_pwd.validate(this)) {
                                            $(this).focus();
                                            return false;
                                        }
                                    });

                                    if (AA.User.isValid) {
                                        AA.Api.User.changeSafePwd(
                                            $('#change-safe-pwd-form:visible').serialize() ,
                                            function (result) {
                                                if (result.state == 1) {
                                                    _dialog.close();
                                                    $.alert({
                                                        tipCls:'success1' ,
                                                        title:'交易密码修改成功!' ,
                                                        content:'为了您的安全，请妥善保管您的密码。' ,
                                                        txtBtn:'确 定' ,
                                                        url:'my/password' ,
                                                        refresh:true
                                                    });
                                                }
                                                else if (result.error == 1009) {
                                                    _dialog.close();
                                                    AA.RapidLogin.popup();
                                                } else if (result.error == 2008) {
                                                    AA.User.warning($('#now-safe-pass').nextAll('.ui-tip') ,AA.Helper.buildError(result.error));
                                                } else {
                                                    AA.User.warning($('#new-safe-pass').nextAll('.ui-tip') ,AA.Helper.buildError(result.error));
                                                }
                                            }
                                            ,
                                            function () {
                                                AA.User.warning(_btn.next('em') ,AA.Helper.buildError(result.error));
                                            }

                                        )
                                    }
                                    return false;
                                });
                            }
                        })
                        ;
                    })
                    ;
                } ,
                validate:function (o) {
                    var _form_input = $(o),
                        _val = $.trim(_form_input.val()),
                        _name = _form_input.attr('name'),
                        _tip = _form_input.nextAll('.ui-tip'),
                        _label = _form_input.prevAll('.ui-form-label').html().replace('：' ,''),
                        _warning = AA.User.warning,
                        _success = AA.User.success,
                        _form = _form_input.parent().parent(),
                        _oldpwd = _form.find('input[name="old_password"]'),
                        _newpwd = $.trim(_form.find('input[name="new_password"]').val());

                    //对显示的文本框进行非空验证
                    if (_val == "") {
                        return _warning(_tip ,'请填写' + _label);
                    } else if (_val.length < 6 || _val.length > 16) {
                        return _warning(_tip ,'密码长度必须在6~16之间');
                    } else {
                        if (_name == 'new_password' && _oldpwd.length != 0) {
                            if (_val == $.trim(_oldpwd.val())) {
                                return _warning(_tip ,'新密码不能与当前密码相同');
                            } else {
                                return _success(_tip);
                            }
                        } else if (_name == 'confirm_password') {
                            if (_val != _newpwd) {
                                return _warning(_tip ,'两次输入密码不一致');
                            } else {
                                return _success(_tip);
                            }
                        } else {
                            return _success(_tip);
                        }
                    }
                }
            } ,
            /**
             * 自动投资
             */
            AutoInvest:{
                init:function (setting) {
                    var _form = $('#auto-invest-form'),
                        _btn_submit = _form.find('.ui-form-action .ui-button'),
                        $money_limit = $('#money_limit'),
                        _label_money = $money_limit.prev('label').html().replace('：' ,''),
                        _tip = _form.find('.ui-tip'),
                        _warning = AA.User.warning,
                        _success = AA.User.success,
                        $priority = $('#priority');

                    if (!AA.Api.User.isAuth) {
                        AA.RapidLogin.popup();
                    } else if (!G_ENV_VAR.IS_CHECKED_EMAIL) {
                        $.alert({
                            title:'您的邮箱尚未经过验证！' ,
                            content:'设置自动投资前请先完成邮箱验证' ,
                            txtBtn:'立即验证' ,
                            url:'my/authinfo#email'
                        });
                    }
                    else if (!G_ENV_VAR.IS_CHECKED_MOBILE) {
                        $.alert({
                            title:'您的手机号尚未经过认证！' ,
                            content:'设置自动投资前请先完成手机认证' ,
                            txtBtn:'立即认证' ,
                            url:'my/authinfo#mobile'
                        });
                    }
                    else if (!G_ENV_VAR.HAS_TRADE_PASSWORD) {
                        $.alert({
                            title:'您尚未设置交易密码！' ,
                            content:'设置自动投资前请先设置交易密码' ,
                            txtBtn:'立即设置' ,
                            url:'my/password#setsafe'
                        });
                    } else {
                        if ($.trim($money_limit.val()) == '') {
                            $money_limit.focus();
                        }

                        //初始化设置
                        $('#rate_range').val(setting.rate_range);
                        $('#money_range').val(setting.money_range);
                        $('#deadline_range').val(setting.deadline_range);
                        $('#priority').val(setting.priority);

                        var _label_priority = $('#priority option:checked').text();
                        $('.label-rate').html($('#rate_range option:checked').text());
                        $('.label-money').html($('#money_range option:checked').text());
                        $('.label-deadline').html($('#deadline_range option:checked').text());
                        $('.label-priority').html(_label_priority);

                        //优先级规则
                        $('.priority-panel input[type="radio"]').each(function () {
                            var _self = $(this);
                            if (_label_priority.indexOf(_self.data('label')) != -1) {
                                _self.attr('checked' ,true);
                            }
                        });

                        $('#priority').mouseover(function () {
                            $priority.hide();
                            $('.priority-panel,.label-priority').addClass('hover');
                            $('.label-priority').html($priority.find('option:selected').html());
                            $('.g2')[$priority.val() != '0' ? 'show' : 'hide']();
                        });

                        $('.priority-panel input[type="radio"]').live('click' ,function () {
                            $('.g2').show();
                            AA.User.Setting.AutoInvest.setPriority();
                        });

                        $('.priority-panel').mouseover(function (e) {
                            $priority.hide();
                            $('.label-priority,.priority-panel').addClass('hover');
                        });


                        $('.priority-panel .ui-button').click(function () {
                            $('#priority option').each(function () {
                                if ($(this).text() == $('.label-priority').html()) {
                                    $(this).attr('selected' ,true);
                                }
                            });

                            $priority.show();
                            $('.priority-panel').hide();
                            $('.priority-panel,.label-priority').removeClass('hover');
                        });

                        $('#auto-invest-form span.hover').live('mouseout' ,function () {
                            $priority.show();
                            $('.priority-panel,.label-priority').removeClass('hover');
                        });

                        _btn_submit.click(function () {
                            if (this.id == 'btn-close') {//关闭
                                $('#status').val('0');
                                AA.User.isValid = true;
                            } else if (this.id == 'btn-edit') { //修改切换
                                $(this).attr('id' ,'btn-update');
                                $(this).val('保 存');
                                _form.removeClass('status-open').addClass('status-close');
                                return false;
                            } else {
                                var _priority = $priority.val(),
                                    _money_limit = $.trim($money_limit.val()),
                                    _lower_money = $('#money_range option:selected').data('min'),
                                    _upper_money = $('#comAutoInvestLimit').val();

                                $('#status').val('1');

                                if (_priority == '0') {
                                    $priority.trigger('mouseover');
                                    return _warning(_tip ,'请设置优先规则');
                                } else {
                                    _success(_tip);
                                }

                                if (_money_limit == '') {
                                    $money_limit.focus();
                                    return _warning(_tip ,'请填写' + _label_money + '金额');
                                } else {
                                    _success(_tip);
                                }

                                var _min_limit = 100;
                                if (parseInt(_money_limit) < _min_limit) {
                                    $money_limit.focus();
                                    return _warning(_tip ,_label_money + '金额不能低于' + _min_limit + '元');
                                } else {
                                    _success(_tip);
                                }

                                if (!/^\d+(\.\d+)?$/.test(_money_limit)) {
                                    $money_limit.focus();
                                    return _warning(_tip ,'金额格式不正确');
                                } else {
                                    _success(_tip);
                                }

                                if (parseFloat(_money_limit) < parseFloat(_lower_money)) {
                                    $money_limit.focus();
                                    return _warning(_tip ,_label_money + '不能低于' + _lower_money + '元');
                                } else {
                                    _success(_tip);
                                }

                                if (parseFloat(_money_limit) > parseFloat(_upper_money)) {
                                    $money_limit.focus();
                                    return _warning(_tip ,_label_money + '不能超过' + _upper_money + '元');
                                } else {
                                    _success(_tip);
                                }
                            }

                            if (AA.User.isValid) {
                                $('.ui-loading').show();

                                AA.Api.User.autoInvest(_form.serialize() ,function (result) {
                                    if (result.state == 1 || result.error == 2072) {//2072表示未修改
                                        if ($('#status').val() == '0') {
                                            _form.removeClass('status-open').addClass('status-close');
                                            $('#btn-edit,#btn-update').attr('id' ,'btn-open').val('开 启');
                                            $('#btn-close').hide();
                                            _tip.show();
                                            $('.auto-invest-status').html('未开启');
                                        } else {
                                            _form.removeClass('status-close').addClass('status-open');
                                            $('#btn-open,#btn-update').attr('id' ,'btn-edit').val('修 改');

                                            $('.label-rate').html($('#rate_range option:checked').text());
                                            $('.label-money').html($('#money_range option:checked').text());
                                            $('.label-deadline').html($('#deadline_range option:checked').text());
                                            $('.label-priority').html($('#priority option:checked').text());
                                            $('.label-money-limit').html($('#money_limit').val());

                                            $('#btn-close').show();
                                            $('.auto-invest-status').html('已开启');
                                        }
                                        _tip.hide();
                                    } else {
                                        var _msg = '';
                                        if (result.error == 1009) {
                                            AA.RapidLogin.popup();
                                        } else if (result.error == 2070) {
                                            _msg = $('#money_range option:selected').data('min') + '元';
                                        } else if (result.error == 2071) {
                                            _msg = $('#comAutoInvestLimit').val() + '元';
                                        }
                                        _warning(_tip ,AA.Helper.buildError(result.error) + _msg);
                                    }
                                    $('.ui-loading').hide();
                                });
                            }
                            return false;
                        });
                    }
                } ,
                /**
                 * 设置优先级规则
                 */
                setPriority:function () {
                    var _label = '';
                    $('.priority-panel input[type="radio"]:checked').each(function () {
                        _label += $(this).data('label') + '、';
                    });
                    _label = _label.substring(0 ,_label.length - 1) + '优先';
                    $('.label-priority').html(_label).addClass('hover');
                }
            }
        } ,
        /**
         * 我的消息
         */
        Msg:{
            init:function () {
                AA.User.Msg.load(1);

                $('#msgtype').change(function () {
                    AA.User.Msg.load(1);
                });
            } ,
            getSelectedRowsID:function (unread) {
                var _unread = unread || false,
                    _cls = _unread ? '.unread' : '',
                    _rows = $('.msg-list li' + _cls + ' input[type="checkbox"]:checked'), _rows_id = '';

                if (_rows.length == 1) {
                    _rows_id = _rows.eq(0).attr('rel');
                } else {
                    var _arr_ids = [];
                    _rows.each(function () {
                        var _self = $(this);
                        _arr_ids.push(_self.attr('rel'));
                    });
                    _rows_id = _arr_ids.join(',');
                }
                return _rows_id;
            } ,
            load:function (pageIndex) {
                AA.Api.Msg.getInfo({
                    page:pageIndex ,
                    is_read:$('#msgtype').val()
                } ,function (result) {
                    if (result.state == 1) {
                        var _d = result.data, _html = '';

                        //更新吊顶未读信息数量
                        $('#j-msg-num').html(_d.notes_num);
                        if (_d.rows.length > 0) {
                            $.each(_d.rows ,function (index ,row) {
                                var _liCls = row.is_read == 1 ? '' : ' class="unread"';
                                _html +=
                                    '<li' + _liCls + '>\
                                        <input type="checkbox" rel="' + row.id + '" />\
                                        <a href="' + AA.Helper.buildUrl('my/msg/') + row.id + '">' + row.subject + '</a>\
                                        <span>' + row.time + '</span>\
                                    </li>';
                            });

                            $('.msg-list ul').html(_html);

                            $('.wgt-pagination').pagination({
                                'total':_d.total ,
                                'showInfo':'<input id="select-all" type="checkbox" />全选  &nbsp;  &nbsp;  &nbsp;<a id="btn-set-delete" class="ui-button ui-button-white ui-button1" href="javascript:;">删除</a>' +
                                    '<a id="btn-set-read" class="ui-button ui-button-white ui-button1" href="javascript:;">标为已读</a>' ,
                                'pageIndex':pageIndex ,
                                'callback':'AA.User.Msg.load'
                            });

                            $('#select-all').click(function () {
                                var _self = this, _check_box = $('.msg-list li input[type="checkbox"]');
                                _check_box.attr('checked' ,_self.checked);
                            });


                            $('#btn-set-delete').click(function () {
                                var _ids = AA.User.Msg.getSelectedRowsID();
                                if (_ids != '') {
                                    $.confirm(AA.User.Msg.confirmMsg('删除后消息将无法恢复，您确定要删除吗？') ,function () {
                                        AA.Api.Msg.doDelete({id:_ids} ,function (result) {
                                            if (result.state == 1) {
                                                AA.User.Msg.load(1);
                                            }
                                        });
                                    } ,function () {
                                        this.close();
                                    });
                                }
                            });

                            $('#btn-set-read').click(function () {
                                var _ids = AA.User.Msg.getSelectedRowsID(true);
                                if (_ids != '') {
                                    AA.Api.Msg.doRead({id:_ids} ,function (result) {
                                        if (result.state == 1) {
                                            $('.msg-list li.unread input[type="checkbox"]:checked').parent('li').removeClass('unread');
                                        }
                                    });
                                }
                            });
                        } else {
                            _html += '<li style="padding: 10px 15px;border-bottom:none;">暂无通知消息</li>';
                            $('.msg-list ul').html(_html);
                            $('.wgt-pagination').html('');
                        }
                    } else {
                        if (result.error == 1009) {
                            AA.RapidLogin.popup();
                        }
                    }
                });
            } ,
            read:function (id) {
                AA.Api.Msg.read({
                    id:id ,
                    is_read:2
                } ,function (result) {
                    if (result.state == 1) {
                        var _d = result.data,
                            _list = $('.msg-list,.msg-header label'),
                            _read = $('.msg-read'),
                            _title = $('.msg-title h1'),
                            _date = $('.msg-title span'),
                            _body = $('.msg-body'),
                            _to_prev = $('#toPrev'),
                            _to_next = $('#toNext');

                        //更新吊顶未读信息数量
                        $('#j-msg-num').html(_d.notes_num);

                        _title.html(_d.subject);
                        _date.html(_d.time);
                        _body.html(_d.content);

                        if (_list.is(':visible')) {
                            _list.hide();
                        }

                        if (!_read.is(':visible')) {
                            _read.show();
                        }

                        if (_d.prev == 0) {
                            _to_prev.hide();
                        } else {
                            _to_prev.show().attr('href' ,AA.Helper.buildUrl('my/msg/' + _d.prev));
                        }

                        if (_d.next == 0) {
                            _to_next.hide();
                        } else {
                            _to_next.show().attr('href' ,AA.Helper.buildUrl('my/msg/' + _d.next));
                        }

                        $('.msg-action .ui-button').click(function () {
                            $.confirm(AA.User.Msg.confirmMsg('删除后消息将无法恢复，您确定要删除吗？') ,function () {
                                AA.Api.Msg.doDelete({id:id} ,function (result) {
                                    var url = '';

                                    if (result.state == 1) {
                                        if (_d.next != 0) {
                                            url = AA.Helper.buildUrl('my/msg/' + _d.next);
                                        } else if (_d.prev != 0) {
                                            url = AA.Helper.buildUrl('my/msg/' + _d.prev);
                                        } else {
                                            AA.Helper.buildUrl('my/msg');
                                        }
                                        location.href = url;
                                    } else {
                                        if (result.error == 1009) {
                                            AA.RapidLogin.popup();
                                        }
                                    }
                                });
                            } ,function () {
                                this.close();
                            });
                        });
                    } else {
                        location.href = AA.Helper.buildUrl('my/msg');
                    }
                });
            } ,
            confirmMsg:function (msg) {
                return '<div style="width:400px;height:50px;"><p class="ui-tip info1" style="margin-top: 15px;font-size:14px;">' + msg + '</div>';
            }
        }
        //登录
      /*   
        Login:{
        	checkIsLogin:function(){
        		$.ajax({
        			url:'/v2/login/in_session_data.jso',
        		    type:'GET' ,
        		    dataType:'json',
        		    success:function (result) {
        				if(result.state==0){
        					checkIsLogin=result.state;
        					return 1;
        				}else if(result.state==1009){
        					checkIsLogin=result.state;
        					return 2;
        				}else{
        					checkIsLogin=result.state;
        					return 3;
        				}
        			}
        		});
        	},
        	checkLogin:function(){
        		if(checkIsLogin==100000||checkIsLogin==undefined){
        			setTimeout(function(){
        	 			AA.User.Login.checkIsLogin();
        	 		},500);
        	 		return;
        		}else{
        			return checkIsLogin;
        		}
        	}
        }*/
    }
})(AA);
